<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>光影星辰</title>
  
  

  

  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="google-site-verification" content="PYt_hX2VWBnIOCJzFpeDmfZ3TCR92Zl7WTDgPfeTpDc">
  <meta name="baidu-site-verification" content="NX7WPDjsb1">
  <!-- meta -->
  
  
  <meta name="theme-color" content="#FFFFFF">
  <meta name="msapplication-TileColor" content="#1BC3FB">
  <meta name="msapplication-config" content="https://cdn.jsdelivr.net/gh/xaoxuu/assets@master/favicon/favicons/browserconfig.xml">
  

  <!-- link -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css">
  
  
  <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/calm2012/file_storage/master/image/apple.ico">
  <link rel="icon" type="image/x-icon" sizes="32x32" href="https://raw.githubusercontent.com/calm2012/file_storage/master/image/apple.ico">
  <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://raw.githubusercontent.com/calm2012/file_storage/master/image/apple.ico">
  <link rel="mask-icon" color="#1BC3FB" href="https://raw.githubusercontent.com/calm2012/file_storage/master/image/apple.ico">
  <link rel="manifest" href="https://cdn.jsdelivr.net/gh/xaoxuu/assets@master/favicon/favicons/site.webmanifest">
  

  

  
  <link rel="stylesheet" href="/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'PYt_hX2VWBnIOCJzFpeDmfZ3TCR92Zl7WTDgPfeTpDc', 'calm2012.github.io');
      ga('send', 'pageview');
    </script>
  
  
    <!-- ba -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1c9bd0bcc92aed38d85380f859e7f47e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>

<body>
    <div id="loading-bar-wrapper">
  <div id="loading-bar" class="pure"></div>
</div>

    <script>setLoadingBarProgress(20)</script>
    <header class="l_header pure">
	<div class="wrapper">
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href="/">
        
          光影星辰
        
      </a>
			<div class="menu">
				<ul class="h-list">
          
  					
  						<li>
								<a id="home" class="nav flat-box" href="/">
									<i class="fas fa-home fa-fw"></i>&nbsp;主页
								</a>
							</li>
      			
  						<li>
								<a id="categories" class="nav flat-box" href="/categories/">
									<i class="fas fa-folder-open fa-fw"></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a id="tags" class="nav flat-box" href="/tags/">
									<i class="fas fa-hashtag fa-fw"></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a id="archives" class="nav flat-box" href="/archives/">
									<i class="fas fa-archive fa-fw"></i>&nbsp;归档
								</a>
							</li>
      			
  						<li>
								<a id="about" class="nav flat-box" href="/about/">
									<i class="fas fa-user fa-fw"></i>&nbsp;关于
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索">
						<span class="icon"><i class="fas fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="flat-btn fas fa-comments fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-toc"><a class="flat-btn fas fa-list fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu">
      <ul>
          
              
                  <li>
										<a id="home" class="nav flat-box" href="/">
											<i class="fas fa-home fa-fw"></i>&nbsp;主页
										</a>
                  </li>
              
                  <li>
										<a id="categories" class="nav flat-box" href="/categories/">
											<i class="fas fa-folder-open fa-fw"></i>&nbsp;分类
										</a>
                  </li>
              
                  <li>
										<a id="tags" class="nav flat-box" href="/tags/">
											<i class="fas fa-hashtag fa-fw"></i>&nbsp;标签
										</a>
                  </li>
              
                  <li>
										<a id="archives" class="nav flat-box" href="/archives/">
											<i class="fas fa-archive fa-fw"></i>&nbsp;归档
										</a>
                  </li>
              
                  <li>
										<a id="about" class="nav flat-box" href="/about/">
											<i class="fas fa-user fa-fw"></i>&nbsp;关于
										</a>
                  </li>
              
       
      </ul>
		</nav>
    </header>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            



  <section class="post-list">
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      



      

      

      
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/C++深入浅出之：C++函数的一些底层细节/">
              
                  C++深入浅出之：C++函数的一些底层细节
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2023-02-24 星期五
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/C-深入浅出系列/C-深入浅出之：C-函数的一些底层细节/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              C++深入浅出系列&nbsp;/&nbsp;C++深入浅出之：C++函数的一些底层细节
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <p>可能我们平时有过以下疑问：</p>
<blockquote>
<ol>
<li>C++函数和C函数有区别吗？</li>
<li>C函数的调用过程是什么样的？</li>
<li>C++函数的调用过程是什么样的？</li>
<li>类似 int sum(int, int)这样的函数，可以被正常调用并返回期望的结果吗？</li>
<li>Obj* obj = nullptr; obj-&gt;show(); obj-&gt;get_name();可以编译通过吗？如果可以，运行后会显示什么？</li>
<li>std::function、std::bind、lambda底层是怎么实现的？</li>
</ol>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Obj::show"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">get_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"obj"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    Obj* obj = <span class="literal">nullptr</span>;</span><br><span class="line">    obj-&gt;show();</span><br><span class="line">    obj-&gt;get_name();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>后续示例代码编译环境:</p>
<blockquote>
<ul>
<li>操作系统：Windows7及以上（推荐Windows11）</li>
<li>编译器：Visual Studio 2010及以上（推荐Visual Studio 2022）</li>
<li>编译选项：x86 debug版本</li>
<li>IDA反汇编工具</li>
<li>一个在线把C++翻译成汇编的网址：<a href="https://godbolt.org" target="_blank" rel="noopener">https://godbolt.org</a><br>没有Windows环境的，也可以借助这个网站来模拟学习，选择x86 msvc v19.lastest</li>
</ul>
</blockquote>
<p>本文涉及到的知识点包括：</p>
<blockquote>
<ul>
<li>C++</li>
<li>x86汇编</li>
<li>栈平衡</li>
<li>软件安全（缓冲区溢出攻击）</li>
</ul>
</blockquote>
<p><strong>本文将从编译器的视角分析编译的C++程序。简单的通过利用调试器、调试器里的反汇编功能，来提供一种剖析C++的底层原理的思路，从而帮我们深入理解C++。</strong><br>文中涉及到的示例代码均可在推荐的开发环境中编译和运行。</p>
<hr>
<h3 id="在分析开篇的那几个问题前，我们先看一个函数的调用过程"><a href="#在分析开篇的那几个问题前，我们先看一个函数的调用过程" class="headerlink" title="在分析开篇的那几个问题前，我们先看一个函数的调用过程"></a>在分析开篇的那几个问题前，我们先看一个函数的调用过程</h3><p>为此，我们采用一段简单的C++代码来说明：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo1.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num1 = sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num1 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>假设我们猜测<code>int num = add(1, 2);</code>调用过程如下：（当然也可以跳过假设直接查看反编译代码）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__asm &#123;</span><br><span class="line">    pushad                  // 保存寄存器当前存储的值</span><br><span class="line">    push 2                  // 把sum(1, 2); 中的参数2压栈</span><br><span class="line">    push 1                  // 把sum(1, 2); 中的参数1压栈</span><br><span class="line">    call sum                // 调用sum函数</span><br><span class="line">    add esp, 8              // 手动做栈平衡（如果把这行注释掉，栈就不平衡了，程序直接崩溃，可自行测试）</span><br><span class="line">    mov num1, eax           // 把sum函数的执行结果，赋值给变量num1</span><br><span class="line">    popad                   // 恢复寄存器数值，恢复为pushad保存的数值</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一些关于汇编的参考资料：<br>x86汇编指令集大全：<a href="https://zhuanlan.zhihu.com/p/53394807" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/53394807</a><br>机械指令 对应 汇编指令：<a href="https://blog.csdn.net/jzxin0/article/details/106069838" target="_blank" rel="noopener">https://blog.csdn.net/jzxin0/article/details/106069838</a><br>那么写一段完整代码来验证：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo1.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num1 = sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num1 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> num2 = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// int num2 = sum(1, 2);函数调用过程，在编译器看来是等效于如下过程：</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad                  <span class="comment">// 保存寄存器当前存储的值</span></span><br><span class="line">        push <span class="number">2</span>                  <span class="comment">// 把sum(1, 2); 中的参数2压栈</span></span><br><span class="line">        push <span class="number">1</span>                  <span class="comment">// 把sum(1, 2); 中的参数1压栈</span></span><br><span class="line">        call sum                <span class="comment">// 调用函数sum</span></span><br><span class="line">        add esp, <span class="number">8</span>              <span class="comment">// 手动做栈平衡</span></span><br><span class="line">        mov num2, eax           <span class="comment">// 把sum的执行结果，赋值给变量num2</span></span><br><span class="line">        popad                   <span class="comment">// 恢复寄存器原来的数值，恢复为pushad保存前的数值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码运行结果如下：<br><a href="https://imgse.com/i/pSzGhqI" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGhqI.png" alt="pSzGhqI.png"></a><br>从执行结果来看，num1的值等于3，num2的值等于3，num1等于num2，也就是说这段内联汇编等效直接调用函数。由此我们可以猜测：<br><strong>函数调用过程：在调用一个__cdecl调用约定的函数前，首先保护当前寄存器的数值，接着是参数入栈，然后调再用该函数，调用结束后接着做栈平衡，最后再恢复寄存的值为函数调用前的值。</strong><br>那么我们如何验证我们猜测呢？<br>我们可以借助调试器的反汇编功能，在调用函数前设置一个断点，然后运行程序，等程序在断点处停下来后，点击鼠标右键选择<code>转到反汇编</code><br><a href="https://imgse.com/i/pSzG5Zt" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzG5Zt.png" alt="pSzG5Zt.png"></a><br>然后我们可以看到：<br><a href="https://imgse.com/i/pSzGfsA" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGfsA.png" alt="pSzGfsA.png"></a><br>可以看到反汇编代码和我们编写的内联汇编代码思想一致，也就证明了我们上述结论是正确的。</p>
<p>这里我们在发散一下：<br>我知道CPU只能识别机器指令（0和1排列组合）。同时一个汇编指令对应一个机器指令，<strong>有没有一种可能让CPU直接执行我们写的0和1机器语言代码呢？</strong> 想起来还有点小激动。<br>为此我们需要补充一些汇编指令对应到机器码的知识，终于在学习若干小时候后（直接快进），我们得到如下代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo2.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num1 = sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num1 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> num2 = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// int num2 = sum(1, 2);函数调用过程，在编译器看来是等效于如下过程：</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad                  <span class="comment">// 保存寄存器当前存储的值</span></span><br><span class="line">        push <span class="number">2</span>                  <span class="comment">// 把sum(1, 2); 中的参数2压栈</span></span><br><span class="line">        push <span class="number">1</span>                  <span class="comment">// 把sum(1, 2); 中的参数1压栈</span></span><br><span class="line">        call sum                <span class="comment">// 调用函数sum</span></span><br><span class="line">        add esp, <span class="number">8</span>              <span class="comment">// 手动做栈平衡</span></span><br><span class="line">        mov num2, eax           <span class="comment">// 把sum的执行结果，赋值给变量num2</span></span><br><span class="line">        popad                   <span class="comment">// 恢复寄存器原来的数值，恢复为pushad保存前的数值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    __asm &#123;</span><br><span class="line">        push ebx</span><br><span class="line">        lea ebx, sum</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 下边的数组shell_code中的代码等效于int num2 = sum(1, 3);</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> shell_code[] &#123;</span><br><span class="line">        <span class="number">0x60</span>,                   <span class="comment">// pushad</span></span><br><span class="line">        <span class="number">0x6A</span>, <span class="number">3</span>,                <span class="comment">// push 3</span></span><br><span class="line">        <span class="number">0x6A</span>, <span class="number">1</span>,                <span class="comment">// push 1</span></span><br><span class="line">        <span class="number">0xFF</span>, <span class="number">0xD3</span>,             <span class="comment">// call ebx(因为ebx存储的值是sum)</span></span><br><span class="line">        <span class="number">0x83</span>, <span class="number">0xC4</span>, <span class="number">8</span>,          <span class="comment">// add esp, 8</span></span><br><span class="line">        <span class="number">0x89</span>, <span class="number">0x45</span>, <span class="number">0xE8</span>,       <span class="comment">// mov num2, eax</span></span><br><span class="line">        <span class="number">0x61</span>,                   <span class="comment">// popad</span></span><br><span class="line">        <span class="number">0xFF</span>, <span class="number">0xE1</span>,             <span class="comment">// jmp ecx(因为ecx存储的值是end_tag, 等效与jmp end_tag)</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 修改数组shell_code这段内存为可读可写可执行</span></span><br><span class="line">    DWORD oldProtect = <span class="number">0</span>;</span><br><span class="line">    VirtualProtect(shell_code, <span class="keyword">sizeof</span>(shell_code), PAGE_EXECUTE_READWRITE, &amp;oldProtect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们直接让CPU执行数组shell_code中的内容</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad                 <span class="comment">// 保存寄存器当前存储的值</span></span><br><span class="line">        lea eax, shell_code    <span class="comment">// 把数组shell_code的地址放入eax</span></span><br><span class="line">        lea ecx, end_tag       <span class="comment">// 把end_tag地址放入ecx</span></span><br><span class="line">        jmp eax                <span class="comment">// 跳转到数组shell_code的首地址</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">end_tag:</span><br><span class="line">    __asm &#123;</span><br><span class="line">        popad                 <span class="comment">// 恢复寄存器原来的数值，恢复为pushad保存前的数值</span></span><br><span class="line">        pop ebx;              <span class="comment">// 恢复ebx寄存器原来的数值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码执行结果如下：<br><a href="https://imgse.com/i/pSzGWMd" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGWMd.png" alt="pSzGWMd.png"></a><br>到此我们应该庆祝一下，现在我们已经掌握了让CPU直接执行0、1代码的方法。<br>但也别高兴的太早，似乎软件安全面临挑战，既然我们可以执行一段由0、1组成的shellcode buffer，那么不法分子也一样可以。如果我们代码有strycpy等类似函数，又没有对输入长度做检查，亦或memcpy(a,b,n)将b中的n个字符拷贝到a处。但是如果 n&gt;a，那么都会存在缓冲区溢出攻击风险。只要不法分子精心构建一段由0、1组成的shellcode，那么我们软件、甚至整个操作系统都有可能受到威胁。<br>有兴趣进一步了解缓冲区溢出攻击的可以自行百度，或者参考文章 <a href="https://zhuanlan.zhihu.com/p/32473371" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/32473371</a> 里的思路。</p>
<h2 id="1-C-函数和C函数有区别吗？"><a href="#1-C-函数和C函数有区别吗？" class="headerlink" title="1. C++函数和C函数有区别吗？"></a>1. C++函数和C函数有区别吗？</h2><h3 id="1-1-C-类成员函数与C函数调用约定不同"><a href="#1-1-C-类成员函数与C函数调用约定不同" class="headerlink" title="1.1 C++类成员函数与C函数调用约定不同"></a>1.1 C++类成员函数与C函数调用约定不同</h3><p>首先我们大家一起回顾一下常见的函数调用约定。<br>|调用方式|参数入栈顺序|局部变量清理由谁清理|<br>|:-:|:-:|:-:|<br>|<strong>pascal|从左到右|函数内部清除（由编译器帮忙实现）|<br>|</strong>cdecl|从右到左|函数外部清除（由编译器帮忙实现）|<br>|<strong>fastcall|从右到左|函数内部清除（由编译器帮忙实现）|<br>|</strong>thiscall|从右到左|函数内部清除（由编译器帮忙实现）|<br>|__stdcall|从右到左|函数内部清除（由编译器帮忙实现）|</p>
<p>其他非常见：<br><strong>nakedcall：一般出现在汇编中，编译器不会给这种函数增加初始化和清理代码。
</strong>vectorcall：尽可能利用寄存器来传递函数的参数变量，<strong>vectorcall对寄存器的使用数目多于</strong>fastcall。</p>
<p><code>__pascal</code>: 是Pascal语言的函数调用方式，其特点是函数参数是从左到右的压栈方式入栈，局部变量在函数内部清除。（在windows下<strong>pascal已经不被msvc编译器所支持，PASCAL实际被编译器替换成了</strong>stdcall）<br><code>__cdecl</code>：是C和C++程序普通函数的缺省调用方式，其特点是函数参数是从右到左的压栈方式入栈，局部变量在函数外部清除。<br><code>__fastcall</code>：调用速度快，前两个（或若干个）参数由寄存器传递，其余参数还是通过堆栈传递。函数参数从右到左的压栈方式入栈，局部变量在函数内部清除。<br><code>__thiscall</code>：是C++类成员函数的调用方式，其特点是this指针被放在特定寄存器中（VC使用ecx），函数参数从右到左的压栈方式入栈，最后一个入栈的是this指，局部变量在函数内部清除.<br><code>__stdcall</code>：其特点函数参数从右到左的压栈方式入栈，局部变量在函数内部清除。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo10.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_def_call</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在windows下__pascal已经不被msvc编译器所支持，PASCAL实际被编译器替换成了__stdcall</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> PASCAL <span class="title">sum_PASCAL</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sum_cdecl</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">fastcall <span class="title">sum_fastcall</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">int</span> __<span class="function">thiscall <span class="title">sum_thiscall</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">sum_stdcall</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num1 = sum_def_call(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> num2 = sum_PASCAL(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> num3 = sum_cdecl(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> num4 = sum_fastcall(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> num5 = Obj().sum_thiscall(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">int</span> num6 = sum_stdcall(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num1 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num3 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num4 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num5 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num6 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的反汇编代码：<br><a href="https://imgse.com/i/pSzGqzQ" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGqzQ.png" alt="pSzGqzQ.png"></a></p>
<p><strong>如果如果入栈参数所占用栈内存，不清理会怎么样？</strong><br>会破坏栈平衡，可能会导致程序直接崩溃。</p>
<h3 id="1-2-C-支持函数重载"><a href="#1-2-C-支持函数重载" class="headerlink" title="1.2 C++支持函数重载"></a>1.2 C++支持函数重载</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo3.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">sum</span><span class="params">(<span class="keyword">double</span> a, <span class="keyword">double</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    sum(<span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过IDA，打开编译好的二进制文件，我可以看到：<br><a href="https://imgse.com/i/pSzG2xH" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzG2xH.png" alt="pSzG2xH.png"></a><br>sum函数名，被编译器改为了j<em>?sum@@YAHHH@Z和j</em>?sum@@YANNN@Z，C++从而支持了函数重载。</p>
<h3 id="1-3-C-支持默认参数"><a href="#1-3-C-支持默认参数" class="headerlink" title="1.3 C++支持默认参数"></a>1.3 C++支持默认参数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo4.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码demo4.c后缀为.C，启动编译编译，构建结果：<br><a href="https://imgse.com/i/pSzGIdP" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGIdP.png" alt="pSzGIdP.png"></a><br>构建失败，说明C语言不支持默认参数。</p>
<h3 id="1-4-C-支持仿函数"><a href="#1-4-C-支持仿函数" class="headerlink" title="1.4 C++支持仿函数"></a>1.4 C++支持仿函数</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo5.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PeoPle</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="string">"xiao_ming"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">18</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name == <span class="string">"xiao_hua"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    PeoPle year;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> y1 = year(<span class="string">"xiao_ming"</span>);  <span class="comment">// 通过operator()，使用起来像一个函数一样</span></span><br><span class="line">    <span class="keyword">int</span> y2 = year(<span class="string">"xiao_hua"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; y1 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; y2 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-5-C-支持std-function"><a href="#1-5-C-支持std-function" class="headerlink" title="1.5 C++支持std::function"></a>1.5 C++支持std::function</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo6.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">int</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)&gt; sum1 = sum;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum1(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://imgse.com/i/pSzGbRg" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGbRg.png" alt="pSzGbRg.png"></a><br>可以看到std::function通过std::function类中operator()操作符重载实现。（当然也可以直接std::function源码来学习具体实现）</p>
<h3 id="1-6-C-支持std-bind"><a href="#1-6-C-支持std-bind" class="headerlink" title="1.6 C++支持std::bind"></a>1.6 C++支持std::bind</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo6.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">int</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)&gt; sum1 = sum;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum1(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> sum2 = <span class="built_in">std</span>::bind(sum, <span class="built_in">std</span>::placeholders::_1, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum2(<span class="number">2</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://imgse.com/i/pSzGOMj" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGOMj.png" alt="pSzGOMj.png"></a><br>可以看到std::bind通过std::bind类中operator()操作符重载实现。（当然也可以直接查看std::bind源码来学习具体实现）</p>
<h3 id="1-7-C-支持lambda表达式"><a href="#1-7-C-支持lambda表达式" class="headerlink" title="1.7 C++支持lambda表达式"></a>1.7 C++支持lambda表达式</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo6.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::function&lt;<span class="keyword">int</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)&gt; sum1 = sum;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum1(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> sum2 = <span class="built_in">std</span>::bind(sum, <span class="built_in">std</span>::placeholders::_1, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum2(<span class="number">2</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> sum3 = [](<span class="keyword">int</span> a, <span class="keyword">int</span> b) -&gt; <span class="keyword">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum3(<span class="number">3</span>, <span class="number">4</span>) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://imgse.com/i/pSzGXss" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGXss.png" alt="pSzGXss.png"></a><br>可以看到lambda表达式是通过匿名类，并且operator()操作符重载实现的。</p>
<h2 id="2-C函数的调用过程是什么样的？"><a href="#2-C函数的调用过程是什么样的？" class="headerlink" title="2. C函数的调用过程是什么样的？"></a>2. C函数的调用过程是什么样的？</h2><p>首先保护当前寄存器的数值，接着是参数入栈，然后调再用该函数，调用结束后接着做栈平衡，最后再恢复寄存的值为函数调用前的值。</p>
<h2 id="3-C-函数的调用过程是什么样的？"><a href="#3-C-函数的调用过程是什么样的？" class="headerlink" title="3. C++函数的调用过程是什么样的？"></a>3. C++函数的调用过程是什么样的？</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo7.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = Obj().sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看反汇编：<br><a href="https://imgse.com/i/pSzGoIf" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGoIf.png" alt="pSzGoIf.png"></a><br>由此可以知：<br>C++普通函数调用过程和C函数是一样，C++类成员函数，调用过程和C函数类似，只是编译器把this指针存入了ecx（msvc编译器是这样，不同编译器可能用不同的寄存器。）</p>
<h2 id="4-类似-int-sum-int-int-这样的函数，可以被正常调用并返回期望的结果吗？"><a href="#4-类似-int-sum-int-int-这样的函数，可以被正常调用并返回期望的结果吗？" class="headerlink" title="4. 类似 int sum(int, int)这样的函数，可以被正常调用并返回期望的结果吗？"></a>4. 类似 int sum(int, int)这样的函数，可以被正常调用并返回期望的结果吗？</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo8.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> <span class="comment">/*a*/</span>, <span class="keyword">int</span> <span class="comment">/*b*/</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>* base = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">int</span>* a = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">int</span>* b = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov base, ebp</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    a = (base + <span class="number">2</span>) + <span class="number">1</span>;  <span class="comment">// call sum有1次push，sum头，push esp，也有1此push，所以要跳过这2个数值，到存放a, b栈地址。</span></span><br><span class="line">    b = (base + <span class="number">2</span>) + <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *a + *b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// call指令等效于先push xx, 在jmp xx</span></span><br><span class="line">    <span class="keyword">int</span> num  = sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行上边代码：<br><a href="https://imgse.com/i/pSzG7i8" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzG7i8.png" alt="pSzG7i8.png"></a><br>由此可知，我们可以通过寄存器esp指向的堆栈，直接拿到想要的参数变量的值，类似 int add(int, int)这种函数也就可以正常工作了。（因为函数来说，无论参数变量有无名称，最终都会被放到栈上，那么我们就有办法直接从栈上取到参数对应的变量）</p>
<h3 id="Obj-obj-nullptr-obj-gt-show-obj-gt-get-name-可以编译通过吗？如果可以，运行后会显示什么？"><a href="#Obj-obj-nullptr-obj-gt-show-obj-gt-get-name-可以编译通过吗？如果可以，运行后会显示什么？" class="headerlink" title="Obj* obj = nullptr; obj-&gt;show(); obj-&gt;get_name();可以编译通过吗？如果可以，运行后会显示什么？"></a>Obj* obj = nullptr; obj-&gt;show(); obj-&gt;get_name();可以编译通过吗？如果可以，运行后会显示什么？</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Obj::show"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">get_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"obj"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    Obj* obj = <span class="literal">nullptr</span>;</span><br><span class="line">    obj-&gt;show();</span><br><span class="line">    obj-&gt;get_name();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行上述代码：<br><a href="https://imgse.com/i/pSzGHJS" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2023/02/24/pSzGHJS.png" alt="pSzGHJS.png"></a><br>obj-&gt;show();是可以调用的，show()属于类，不管有没有类实例，show()都是存在的（被所有类实例共享）。<br>obj-&gt;get_name();由于需要先找到虚表，再从虚表找到get_name()函数的地址，虚表放在obj的首地址，而obj值是nullptr，程序崩溃</p>
<p><strong>最后，只要我们要学会了善于利用调试器，以及调试器里边的反汇编功能，假以时日，那些看似遥不可及的C++底层原理，也必然为我们所用！</strong></p>
<hr>
<p>一些题外话：<br>当下还有什么工程用到了汇编么吗？<br>1.Linux内核：<a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/copy.S" target="_blank" rel="noopener">https://github.com/torvalds/linux/blob/master/arch/x86/boot/copy.S</a><br>2.FFmpeg多媒体框架：<a href="https://github.com/FFmpeg/FFmpeg/tree/master/libavutil/x86" target="_blank" rel="noopener">https://github.com/FFmpeg/FFmpeg/tree/master/libavutil/x86</a><br>3.OpenSSL加密库：<a href="https://github.com/openssl/openssl/tree/master/crypto/x86" target="_blank" rel="noopener">https://github.com/openssl/openssl/tree/master/crypto/x86</a><br>4.GCC编译器：<a href="https://github.com/gcc-mirror/gcc/blob/master/gcc/config/i386/i386.cc" target="_blank" rel="noopener">https://github.com/gcc-mirror/gcc/blob/master/gcc/config/i386/i386.cc</a><br>5.NASM汇编器：<a href="https://github.com/netwide-assembler/nasm" target="_blank" rel="noopener">https://github.com/netwide-assembler/nasm</a><br>6.libyuv：<a href="https://github.com/sayrer/libyuv/blob/master/source/scale_win.cc" target="_blank" rel="noopener">https://github.com/sayrer/libyuv/blob/master/source/scale_win.cc</a> libyuv是google 开源的用于实现对各种yuv数据之间的转换包括裁剪、缩放、旋转，以及yuv和rgb 之间的转换，底层有一部分代码是基于汇编实现的，大大提高了转换速度。<br>libyuv被广泛用于 音视频SDK中。</p>
<p>编程就像修高楼，只有夯实基础，万丈高楼才能平地起，这样的大楼自然经得住风吹雨打！</p>
        
            <div class="readmore">
                <a href="/C++深入浅出之：C++函数的一些底层细节/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/C-深入浅出系列/"><i class="fas fa-hashtag fa-fw"></i>C++深入浅出系列</a>
                
                    <a href="/tags/C-深入浅出之：C-函数的一些底层细节/"><i class="fas fa-hashtag fa-fw"></i>C++深入浅出之：C++函数的一些底层细节</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/UAC实现原理/">
              
                  UAC实现原理
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2022-09-03 星期六
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/Windows/UAC实现原理/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              Windows&nbsp;/&nbsp;UAC实现原理
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="UAC实现原理："><a href="#UAC实现原理：" class="headerlink" title="UAC实现原理："></a>UAC实现原理：</h2><ul>
<li>当用户登录系统成功后， 系统会为用户生成一个accessToken。该用户调用的每一个进程都会有一个AccessToken copy。当进程要访问某个securable object 时，系统会比对accessToken拥有的权限（previlages 是否能访问securable object）</li>
<li>如果安全描述符中不存在DACL，则系统会允许线程进行访问。如果存在DACL，系统会顺序遍历DACL中的每个ACE，检查ACE中的SID在线程的AccessTkoen中是否存在。以访问者中的User SID或Group SID作为关键字查询被访问对象中的DACL。顺序：先查询类型为DENY的ACE，若命中且权限符合则访问拒绝；未命中再在ALLOWED类型的ACE中查询，若命中且类型符合则可以访问；如果前两步后还没命中那么访问拒绝。</li>
</ul>
<p><strong>相关概念：</strong><br><strong>ntoskrnl.exe：</strong> ntoskrnl.exe 是 Windows 操作系统的一个重要内核程序文件，里面存储了大量的二进制内核代码，用于调度系统。<br><strong>Windows执行体：</strong> Windows执行体是ntoskrnl.exe中的上层（内核是其下层）。<br><strong>对象管理器（Object Manager）：</strong> 创建、管理和删除Windows执行体对象和抽象数据类型，他们（抽象数据类型）代表了操作系统资源，比如进程、线程和各种同步对象。</p>
<p><strong>环境子系统：</strong> 环境子系统是操作系统中名词。环境子系统向应用程序提供环境和应用程序编程接口(Appplication Programming Interface, API）。Windows 2000/XP支持三种环境子系统：Win32、POSIX和OS/2，其中最重要的环境子系统是Win32子系统，其他子系统都要通过Win32子系统接收用户的输入和显示输出。环境子系统的作用是将基本的执行体系统服务的某些子集提供给应用程序。 用户应用程序调用系统服务时必须通过一个或多个子系统动态链接库作为中介才可以完成。<br><strong>执行体对象：</strong> 每个Windows环境子系统总是把操作系统的不同面貌呈现给它的应用程序。执行体对象和对象服务是环境子系统用于构建其自有版本的对象和其他资源的基础。<br><strong>安全描述符（Security descriptors）：</strong> 是安全信息的数据结构（SECURITY_DESCRIPTOR），用于可安全（securable）的Windows对象，这些对象可以被唯一名称辨识。安全描述符可用于任何命名对象，包括文件、文件夹、共享、注册表键、进程、线程、命名管道、服务、工作对象以及其他资源。</p>
<ul>
<li>版本号：创建此描述符的SRM安全模型的版本;</li>
<li>标志：一些可选的修饰符，定义了该描述符的行为或特征。表6.5列出了这些标志;</li>
<li>所有者SID：所有者的安全ID</li>
<li>组SID：该对象的主组的安全ID（仅用于POSIX）</li>
<li>自主访问控制列表（discretionary access control list，DACL）：规定了谁可以用什么方式访问该对象。</li>
<li>系统访问控制列表(System Access Control List，SACL)规定了哪些用户的哪些操作应该被记录到安全审计日志中，以及对象的显式完整性级别。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_DESCRIPTOR</span> &#123;</span>  </span><br><span class="line">  UCHAR  Revision;  </span><br><span class="line">  UCHAR  Sbz1;  </span><br><span class="line">  SECURITY_DESCRIPTOR_CONTROL  Control; <span class="comment">//其自身的一些控制位  </span></span><br><span class="line">  PSID  Owner; <span class="comment">//Owner安全标识符(Security identifiers) 相当于UUID，标识用户、用户群、计算机帐户  </span></span><br><span class="line">  PSID  Group; <span class="comment">//Group安全标识符(Security identifiers) 相当于UUID  </span></span><br><span class="line">  PACL  Sacl; <span class="comment">//（System Access Control List），其指出了在该对象上的一组存取方式（如，读、写、运行等）的存取控制权限细节的列表。  </span></span><br><span class="line">  PACL  Dacl; <span class="comment">//（Discretionary Access Control List），其指出了允许和拒绝某用户或用户组的存取控制列表。 如果一个对象没有DACL，那么就是说这个对象是任何人都可以拥有完全的访问权限。   </span></span><br><span class="line">&#125; SECURITY_DESCRIPTOR, *PISECURITY_DESCRIPTOR;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ACL</span> &#123;</span>  </span><br><span class="line">    BYTE  AclRevision;  </span><br><span class="line">    BYTE  Sbz1;  </span><br><span class="line">    WORD   AclSize;  </span><br><span class="line">    WORD   AceCount;  </span><br><span class="line">    WORD   Sbz2;  </span><br><span class="line">&#125; ACL, *PACL;</span><br></pre></td></tr></table></figure>
<p><strong>安全标识符 (Security Identifier，SID)：</strong> 是Windows操作系统使用的独一无二的，不变的标识符用于标识用户、用户群、或其他安全主体。<br><strong>可移植操作系统接口（POSIX）：</strong> 是IEEE为要在各种UNIX操作系统上运行软件，而定义API的一系列互相关联的标准的总称。<br><strong>访问控制项（ access control entries，ACE）：</strong><br><strong>安全描述符：</strong> 包含自主决定的访问控制表（DACL），里面包含有访问控制项（ACE），因此可以允许或拒绝特定用户或用户组的访问。它们还包含一个系统访问控制列表（SACL）以控制对象访问请求的日志（logging）。[2][3]ACE可以显式应用于对象，或者从父对象继承。ACE的顺序在ACL中很重要，拒绝访问的ACE应该比允许访问的ACE更早出现。安全描述符还包含对象所有者。<br><strong>访问控制列表（access control list，ACL）：</strong> 访问控制列表(ACL，access-control list)是由一个头和零个或多个访问控制项(ACE, access-control entry)结构组成的。共有两种类型的ACL: DACL和SACL。在DACL中，每一个ACE包含一个SID和一个访问掩码。</p>
<hr>
        
            <div class="readmore">
                <a href="/UAC实现原理/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/Windows/"><i class="fas fa-hashtag fa-fw"></i>Windows</a>
                
                    <a href="/tags/UAC实现原理/"><i class="fas fa-hashtag fa-fw"></i>UAC实现原理</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/GoogleTest环境配置以及应用/">
              
                  GoogleTest环境配置以及应用
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2022-08-20 星期六
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/自动化测试/GoogleTest/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              自动化测试&nbsp;/&nbsp;GoogleTest
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h1 id="GoogleTest环境配置以及应用"><a href="#GoogleTest环境配置以及应用" class="headerlink" title="GoogleTest环境配置以及应用"></a>GoogleTest环境配置以及应用</h1><ul>
<li><a href="#googletest环境配置以及应用">GoogleTest环境配置以及应用</a><ul>
<li><a href="#1-googletest源码编译">1 GoogleTest源码编译：</a><ul>
<li><a href="#11-windows下googletest的编译方法包含example">1.1 Windows下GoogleTest的编译方法（包含example）:</a></li>
<li><a href="#12-linux下googletest的编译方法包含example">1.2 Linux下GoogleTest的编译方法（包含example）:</a></li>
<li><a href="#编译参数含义说明">编译参数含义说明：</a></li>
</ul>
</li>
<li><a href="#2-googletest常用测试宏">2 GoogleTest常用测试宏：</a></li>
<li><a href="#3-googletest使用步骤">3 GoogleTest使用步骤</a><ul>
<li><a href="#31-以sample1为例">3.1 以sample1为例：</a><ul>
<li><a href="#311-sample1目录结构如下">3.1.1 sample1目录结构如下：</a></li>
<li><a href="#312编译构建命令">3.1.2编译构建命令：</a></li>
</ul>
</li>
<li><a href="#32-再看在messagepush工程中如何引入googletest">3.2 再看在MessagePush工程中如何引入GoogleTest</a><ul>
<li><a href="#321-最后在你的工程里如cmakeliststxt中引入">3.2.1 最后在你的工程里如CMakeLists.txt中引入：</a></li>
</ul>
</li>
<li><a href="#33-googletest常用测试宏testtest_ftest_ptyped_test的一般使用场景">3.3 GoogleTest常用测试宏(TEST/TEST_F/TEST_P/TYPED_TEST)的一般使用场景:</a></li>
<li><a href="#34-其它参考网址">3.4 其它参考网址:</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="1-GoogleTest源码编译："><a href="#1-GoogleTest源码编译：" class="headerlink" title="1 GoogleTest源码编译："></a>1 GoogleTest源码编译：</h2><p>GoogleTest代码仓库URL:<br><a href="https://github.com/google/googletest.git" target="_blank" rel="noopener">https://github.com/google/googletest.git</a><br>下载源代码：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --branch release-1.12.1 https://github.com/google/googletest.git googletest</span><br></pre></td></tr></table></figure></p>
<h3 id="1-1-Windows下GoogleTest的编译方法（包含example）"><a href="#1-1-Windows下GoogleTest的编译方法（包含example）" class="headerlink" title="1.1 Windows下GoogleTest的编译方法（包含example）:"></a>1.1 Windows下GoogleTest的编译方法（包含example）:</h3><p>这里选择的编译器是Visual Studio 16 2019，需要用别的版本的编译器，请自行重新指定一下编译器版本：</p>
<blockquote>
<p>VS2022为：”Visual Studio 17 2022”<br>VS2019为：”Visual Studio 16 2019”<br>VS2017为：”Visual Studio 15 2017”<br>VS2015为：”Visual Studio 14 2015”<br>VS2013为：”Visual Studio 12 2013”<br>VS2012为：”Visual Studio 11 2012”<br>VS2010为：”Visual Studio 10 2010”</p>
</blockquote>
<p>1.1.1 debug版本编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir debug    <span class="comment"># 在源码根目录创建一个名叫debug的文件夹</span></span><br><span class="line"><span class="built_in">cd</span> debug       <span class="comment"># 进入debug文件夹</span></span><br><span class="line">cmake <span class="string">"../"</span> -DCMAKE_CONFIGURATION_TYPES=Debug -Dgtest_force_shared_crt=ON -Dgtest_build_samples=ON -DCMAKE_INSTALL_PREFIX=D:/SDK/GoogleTest/v1.10.x/debug -G <span class="string">"Visual Studio 16 2019"</span> -A x64</span><br></pre></td></tr></table></figure></p>
<p>1.1.2 release版本编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir release   <span class="comment"># 在源码根目录创建一个名叫release的文件夹</span></span><br><span class="line"><span class="built_in">cd</span> release      <span class="comment"># 进入release文件夹</span></span><br><span class="line">cmake <span class="string">"../"</span> -DCMAKE_CONFIGURATION_TYPES=Release -Dgtest_force_shared_crt=ON -Dgtest_build_samples=ON -DCMAKE_INSTALL_PREFIX=D:/SDK/GoogleTest/v1.10.x/release -G <span class="string">"Visual Studio 16 2019"</span> -A x64</span><br></pre></td></tr></table></figure></p>
<p>生成install文件：<br>管理员启动：x64_x86 Cross Tools Command Prompt for VS 2019.lnk<br>然后执行：msbuild INSTALL.vcxproj (release版本可能会报错)<br>或者使用用：cmake –build . –target INSTALL –config Release 编译并安装。</p>
<h3 id="1-2-Linux下GoogleTest的编译方法（包含example）"><a href="#1-2-Linux下GoogleTest的编译方法（包含example）" class="headerlink" title="1.2 Linux下GoogleTest的编译方法（包含example）:"></a>1.2 Linux下GoogleTest的编译方法（包含example）:</h3><p>1.2.1 debug版本编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir debug    <span class="comment"># 在源码根目录创建一个名叫debug的文件夹</span></span><br><span class="line"><span class="built_in">cd</span> debug       <span class="comment"># 进入debug文件夹</span></span><br><span class="line">cmake <span class="string">"../"</span> \</span><br><span class="line">-DCMAKE_BUILD_TYPE=Debug \</span><br><span class="line">-DCMAKE_DEBUG_POSTFIX=d \</span><br><span class="line">-Dgtest_force_shared_crt=ON \</span><br><span class="line">-Dgtest_build_samples=ON \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=~/SDK/googletest/v1.12.1/debug \</span><br><span class="line">-DCMAKE_C_COMPILER=/usr/bin/gcc-11 \</span><br><span class="line">-DCMAKE_CXX_COMPILER=/usr/bin/g++-11</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p>
<p>1.2.2 release版本编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir release   <span class="comment"># 在源码根目录创建一个名叫release的文件夹</span></span><br><span class="line"><span class="built_in">cd</span> release      <span class="comment"># 进入release文件夹</span></span><br><span class="line">cmake <span class="string">"../"</span> \</span><br><span class="line">-DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">-Dgtest_force_shared_crt=ON \</span><br><span class="line">-Dgtest_build_samples=ON \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=~/SDK/googletest/v1.12.1/release \</span><br><span class="line">-DCMAKE_C_COMPILER=/usr/bin/gcc-11 \</span><br><span class="line">-DCMAKE_CXX_COMPILER=/usr/bin/g++-11</span><br></pre></td></tr></table></figure></p>
<h3 id="编译参数含义说明："><a href="#编译参数含义说明：" class="headerlink" title="编译参数含义说明："></a>编译参数含义说明：</h3><blockquote>
<p>-DCMAKE_BUILD_TYPE：用来制定编译Debug版本，还是Release版本。<br>-DCMAKE_DEBUG_POSTFIX：debug版本生成lib追加的后缀名（d表示原本为xx.so，编译生成的是xxd.so）<br>-Dgtest_force_shared_crt=ON：Winodws设置构建库类型为MD。<br>-DCMAKE_INSTALL_PREFIX=~/SDK/googletest/v1.12.1/debug ：指定SDK生成后的保存目录。<br>-DCMAKE_C_COMPILER=/usr/bin/gcc-11：指定使用的gcc编译版本。<br>-DCMAKE_CXX_COMPILER=/usr/bin/g++-11：指定使用的g++版本。</p>
</blockquote>
<hr>
<h2 id="2-GoogleTest常用测试宏："><a href="#2-GoogleTest常用测试宏：" class="headerlink" title="2 GoogleTest常用测试宏："></a>2 GoogleTest常用测试宏：</h2><table>
<thead>
<tr>
<th style="text-align:left">ASSERT宏</th>
<th style="text-align:left">EXPECT宏</th>
<th style="text-align:left">功能</th>
<th style="text-align:left">使用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>ASSERT_TRUE|EXPECT_TRUE|判真|判断表达式真假<br>ASSERT_FALSE|EXPECT_FALSE|判假|判断表达式真假<br>ASSERT_EQ|EXPECT_EQ|相等|数值比较<br>ASSERT_NE|EXPECT_NE|不等|数值比较<br>ASSERT_GT|EXPECT_GT|大于|数值比较<br>ASSERT_LT|EXPECT_LT|小于|数值比较<br>ASSERT_GE|EXPECT_GE|大于或等于|数值比较<br>ASSERT_LE|EXPECT_LE|小于或等于|数值比较<br>ASSERT_FLOAT_EQ|EXPECT_FLOAT_EQ|单精度浮点值相等|数值比较<br>ASSERT_DOUBLE_EQ|EXPECT_DOUBLE_EQ|双精度浮点值相等|数值比较<br>ASSERT_NEAR|EXPECT_NEAR|浮点值接近（第3个参数为误差阈值）|双精度浮点值相等、数值比价<br>ASSERT_STREQ|EXPECT_STREQ|C字符串相等|字符串比较<br>ASSERT_STRNE|EXPECT_STRNE|C字符串不等|字符串比较<br>ASSERT_STRCASEEQ|EXPECT_STRCASEEQ|C字符串相等（忽略大小写）|字符串比较<br>ASSERT_STRCASENE|EXPECT_STRCASENE|C字符串不等（忽略大小写）|字符串比较<br>ASSERT_PRED1|EXPECT_PRED1|自定义谓词函数，(pred, arg1)（还有_PRED2, …, _PRED5|自定义比较函数</p>
<hr>
<h2 id="3-GoogleTest使用步骤"><a href="#3-GoogleTest使用步骤" class="headerlink" title="3 GoogleTest使用步骤"></a>3 GoogleTest使用步骤</h2><h3 id="3-1-以sample1为例："><a href="#3-1-以sample1为例：" class="headerlink" title="3.1 以sample1为例："></a>3.1 以sample1为例：</h3><p>sample1源码地址:<a href="https://github.com/calm2012/my_sample_code/tree/main/GoogleTest/GoogleTest_sample1" target="_blank" rel="noopener">https://github.com/calm2012/my_sample_code/tree/main/GoogleTest/GoogleTest_sample1</a></p>
<h4 id="3-1-1-sample1目录结构如下："><a href="#3-1-1-sample1目录结构如下：" class="headerlink" title="3.1.1 sample1目录结构如下："></a>3.1.1 sample1目录结构如下：</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">└─sample1</span><br><span class="line">    │  CMakeLists.txt</span><br><span class="line">    │  sample1.h</span><br><span class="line">    │  sample1.cc</span><br><span class="line">    │  sample1_unittest.cc</span><br><span class="line">    │</span><br><span class="line">    ├─debug</span><br><span class="line">    └─googletest_lib</span><br></pre></td></tr></table></figure>
<p><strong>CMakeLists.txt文件内容如下:</strong><br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.14</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(sample1 LANGUAGES CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">17</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(sample1</span><br><span class="line">    sample1.h</span><br><span class="line">    sample1.cc</span><br><span class="line">    sample1_unittest.cc</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接gtest_maind.lib库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(sample1 <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/googletest_lib/lib/debug/gtest_maind.lib)</span><br><span class="line"><span class="comment"># 链接gtestd.lib库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(sample1 <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/googletest_lib/lib/debug/gtestd.lib)</span><br><span class="line"><span class="comment"># 在工程中共引入GoogleTest头文件搜索路径</span></span><br><span class="line"><span class="keyword">target_include_directories</span>(sample1 PUBLIC <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/googletest_lib/<span class="keyword">include</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>sample1.h文件内容如下:</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> GTEST_SAMPLES_SAMPLE1_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GTEST_SAMPLES_SAMPLE1_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns n! (the factorial of n).  For negative n, n! is defined to be 1.</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Factorial</span><span class="params">(<span class="keyword">int</span> n)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// GTEST_SAMPLES_SAMPLE1_H_</span></span></span><br></pre></td></tr></table></figure></p>
<p><strong>sample1.cc文件内容如下:</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample1.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Returns n! (the factorial of n).  For negative n, n! is defined to be 1.</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Factorial</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">    result *= i;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>sample1_unittest.cc文件内容如下:</strong><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample1.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"gtest/gtest.h"</span></span></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tests factorial of negative numbers.</span></span><br><span class="line">TEST(FactorialTest, Negative) &#123;</span><br><span class="line">  <span class="comment">// This test is named "Negative", and belongs to the "FactorialTest"</span></span><br><span class="line">  <span class="comment">// test case.</span></span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">-5</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">-1</span>));</span><br><span class="line">  EXPECT_GT(Factorial(<span class="number">-10</span>), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tests factorial of 0.</span></span><br><span class="line">TEST(FactorialTest, Zero) &#123;</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Tests factorial of positive numbers.</span></span><br><span class="line">TEST(FactorialTest, Positive) &#123;</span><br><span class="line">  EXPECT_EQ(<span class="number">1</span>, Factorial(<span class="number">1</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">2</span>, Factorial(<span class="number">2</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">6</span>, Factorial(<span class="number">3</span>));</span><br><span class="line">  EXPECT_EQ(<span class="number">40320</span>, Factorial(<span class="number">8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace</span></span><br></pre></td></tr></table></figure></p>
<h4 id="3-1-2编译构建命令："><a href="#3-1-2编译构建命令：" class="headerlink" title="3.1.2编译构建命令："></a>3.1.2编译构建命令：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir debug</span><br><span class="line"><span class="built_in">cd</span> debug</span><br><span class="line">cmake <span class="string">"../"</span> \</span><br><span class="line">-DCMAKE_BUILD_TYPE:STRING=Debug \</span><br><span class="line">-DCMAKE_C_COMPILER:STRING=/usr/bin/gcc \</span><br><span class="line">-DCMAKE_CXX_COMPILER:STRING=/usr/bin/g++</span><br><span class="line">cmake --build . --config Debug</span><br><span class="line"><span class="built_in">cd</span> Debug</span><br><span class="line">运行：sample1</span><br></pre></td></tr></table></figure>
<h3 id="3-2-再看在MessagePush工程中如何引入GoogleTest"><a href="#3-2-再看在MessagePush工程中如何引入GoogleTest" class="headerlink" title="3.2 再看在MessagePush工程中如何引入GoogleTest"></a>3.2 再看在MessagePush工程中如何引入GoogleTest</h3><h4 id="3-2-1-最后在你的工程里如CMakeLists-txt中引入："><a href="#3-2-1-最后在你的工程里如CMakeLists-txt中引入：" class="headerlink" title="3.2.1 最后在你的工程里如CMakeLists.txt中引入："></a>3.2.1 最后在你的工程里如CMakeLists.txt中引入：</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add_gtest(base_common_unittest)</span><br><span class="line"><span class="comment"># 或者:</span></span><br><span class="line">add_gtest_main(mysql_wrapper_unittest)</span><br></pre></td></tr></table></figure>
<ul>
<li>add_gtest的作用是为了在Windows下添加gtest.lib，或者Linux下添加libgtest.a。同时引入GoogleTest头文件搜索路径</li>
<li>add_gtest_main的作用是为了在Windows下添加gtest.lib、gtest_main.lib，或者Linux下添加libgtest.a、libgtest_main.a。同时引入GoogleTest头文件搜索路径</li>
</ul>
<p>add_gtest宏：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">macro</span>(add_gtest target_name)</span><br><span class="line">    <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;target_name&#125;</span></span><br><span class="line">        <span class="variable">$&#123;googletest_lib_path&#125;</span>/<span class="variable">$&#123;gtes_lib_name&#125;</span>     <span class="comment"># googletest_lib_path: gooltest库文件路径</span></span><br><span class="line">        <span class="variable">$&#123;target_name&#125;</span> <span class="variable">$&#123;googletest_lib_path&#125;</span>/<span class="variable">$&#123;gmock_lib_name&#125;</span></span><br><span class="line">        -lpthread</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">target_include_directories</span>(<span class="variable">$&#123;target_name&#125;</span> PUBLIC <span class="variable">$&#123;googletest_include_path&#125;</span>)</span><br><span class="line"><span class="keyword">endmacro</span>(add_gtest)</span><br></pre></td></tr></table></figure></p>
<p>add_gtest_main宏：<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">macro</span>(add_gtest_main target_name)</span><br><span class="line">    <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;target_name&#125;</span></span><br><span class="line">        <span class="variable">$&#123;googletest_lib_path&#125;</span>/<span class="variable">$&#123;gtes_lib_name&#125;</span> <span class="comment"># googletest_lib_path: gooltest库文件路径</span></span><br><span class="line">        <span class="variable">$&#123;googletest_lib_path&#125;</span>/<span class="variable">$&#123;gtes_main_lib_name&#125;</span></span><br><span class="line">        <span class="variable">$&#123;googletest_lib_path&#125;</span>/<span class="variable">$&#123;gmock_lib_name&#125;</span></span><br><span class="line">        <span class="variable">$&#123;googletest_lib_path&#125;</span>/<span class="variable">$&#123;gmock_main_lib_name&#125;</span></span><br><span class="line">        -lpthread</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">target_include_directories</span>(<span class="variable">$&#123;target_name&#125;</span> PUBLIC <span class="variable">$&#123;googletest_include_path&#125;</span>)</span><br><span class="line"><span class="keyword">endmacro</span>(add_gtest_main)</span><br></pre></td></tr></table></figure></p>
<h3 id="3-3-GoogleTest常用测试宏-TEST-TEST-F-TEST-P-TYPED-TEST-的一般使用场景"><a href="#3-3-GoogleTest常用测试宏-TEST-TEST-F-TEST-P-TYPED-TEST-的一般使用场景" class="headerlink" title="3.3 GoogleTest常用测试宏(TEST/TEST_F/TEST_P/TYPED_TEST)的一般使用场景:"></a>3.3 GoogleTest常用测试宏(TEST/TEST_F/TEST_P/TYPED_TEST)的一般使用场景:</h3><ul>
<li>TEST：通常用于简单的函数测试。</li>
<li>TEST_F：通常用于需要访问类对象时的测试。</li>
<li>TEST_P：通常用于把测试对象当作参数传入或有大量重复测试case时。</li>
<li>TYPED_TEST：通常用于接口测试。</li>
</ul>
<h3 id="3-4-其它参考网址"><a href="#3-4-其它参考网址" class="headerlink" title="3.4 其它参考网址:"></a>3.4 其它参考网址:</h3><ul>
<li>googletest：<a href="https://github.com/google/googletest" target="_blank" rel="noopener">https://github.com/google/googletest</a></li>
<li>googletest-gmock使用示例：<a href="https://zhuanlan.zhihu.com/p/101906555" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/101906555</a></li>
<li>GoogleTest单元测试学习：<a href="https://blog.csdn.net/Tosonw/article/details/89449285" target="_blank" rel="noopener">https://blog.csdn.net/Tosonw/article/details/89449285</a></li>
<li>GoogleTest Primer：<a href="https://blog.csdn.net/qq_34548075/article/details/122864792" target="_blank" rel="noopener">https://blog.csdn.net/qq_34548075/article/details/122864792</a></li>
</ul>
<hr>
        
            <div class="readmore">
                <a href="/GoogleTest环境配置以及应用/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/自动化测试/"><i class="fas fa-hashtag fa-fw"></i>自动化测试</a>
                
                    <a href="/tags/GoogleTest/"><i class="fas fa-hashtag fa-fw"></i>GoogleTest</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/11.3 关闭非活动连接/">
              
                  11.3 关闭非活动连接
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2022-08-14 星期日
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/linux/Linux高性能服务器编程/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              linux&nbsp;/&nbsp;Linux高性能服务器编程
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lst_timer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FD_LIMIT 65535</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_EVENT_NUMBER 1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMESLOT 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">static</span> sort_timer_lst timer_lst;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> epollfd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">setnonblocking</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> old_option = fcntl(fd, F_GETFL);</span><br><span class="line">    <span class="keyword">int</span> new_option = old_option | O_NONBLOCK;</span><br><span class="line">    fcntl(fd, F_SETFL, new_option);</span><br><span class="line">    <span class="keyword">return</span> old_option;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addfd</span><span class="params">(<span class="keyword">int</span> epollfd, <span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    epoll_event event;</span><br><span class="line">    event.data.fd = fd;</span><br><span class="line">    event.events = EPOLLIN | EPOLLET;</span><br><span class="line">    epoll_ctl(epollfd, EPOLL_CTL_ADD, fd, &amp;event);</span><br><span class="line">    setnonblocking(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> save_errno = errno;</span><br><span class="line">    <span class="keyword">int</span> msg = sig;</span><br><span class="line">    send(pipefd[<span class="number">1</span>], (<span class="keyword">char</span>*)&amp;msg, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    errno = save_errno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addsig</span><span class="params">(<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    sa.sa_handler = sig_handler;</span><br><span class="line">    sa.sa_flags |= SA_RESTART;</span><br><span class="line">    sigfillset(&amp;sa.sa_mask);</span><br><span class="line">    assert(sigaction(sig, &amp;sa, <span class="literal">NULL</span>) != <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timer_handler</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    timer_lst.tick();</span><br><span class="line">    alarm(TIMESLOT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cb_func</span><span class="params">(client_data* user_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    epoll_ctl(epollfd, EPOLL_CTL_DEL, user_data-&gt;sockfd, <span class="number">0</span>);</span><br><span class="line">    assert(user_data);</span><br><span class="line">    close(user_data-&gt;sockfd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"close fd %d\n"</span>, user_data-&gt;sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"usage: %s ip_address port_number\n"</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> listenfd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(listenfd &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ret = bind(listenfd, (struct sockaddr*)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(listenfd, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    epoll_event events[MAX_EVENT_NUMBER];</span><br><span class="line">    <span class="keyword">int</span> epollfd = epoll_create(<span class="number">5</span>);</span><br><span class="line">    assert(epollfd != <span class="number">-1</span>);</span><br><span class="line">    addfd(epollfd, listenfd);</span><br><span class="line"></span><br><span class="line">    ret = socketpair(PF_UNIX, SOCK_STREAM, <span class="number">0</span>, pipefd);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line">    setnonblocking(pipefd[<span class="number">1</span>]);</span><br><span class="line">    addfd(epollfd, pipefd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add all the interesting signals here</span></span><br><span class="line">    addsig(SIGALRM);</span><br><span class="line">    addsig(SIGTERM);</span><br><span class="line">    <span class="keyword">bool</span> stop_server = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    client_data* users = <span class="keyword">new</span> client_data[FD_LIMIT];</span><br><span class="line">    <span class="keyword">bool</span> timeout = <span class="literal">false</span>;</span><br><span class="line">    alarm(TIMESLOT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!stop_server)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> number = epoll_wait(epollfd, events, MAX_EVENT_NUMBER, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> ((number &lt; <span class="number">0</span>) &amp;&amp; (errno != EINTR))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"epoll failure\n"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; number; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> sockfd = events[i].data.fd;</span><br><span class="line">            <span class="keyword">if</span> (sockfd == listenfd)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_address</span>;</span></span><br><span class="line">                <span class="keyword">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client_address);</span><br><span class="line">                <span class="keyword">int</span> connfd = accept(listenfd, (struct sockaddr*)&amp;client_address, &amp;client_addrlength);</span><br><span class="line">                addfd(epollfd, connfd);</span><br><span class="line">                users[connfd].address = client_address;</span><br><span class="line">                users[connfd].sockfd = connfd;</span><br><span class="line">                util_timer* timer = <span class="keyword">new</span> util_timer;</span><br><span class="line">                timer-&gt;user_data = &amp;users[connfd];</span><br><span class="line">                timer-&gt;cb_func = cb_func;</span><br><span class="line">                <span class="keyword">time_t</span> cur = time(<span class="literal">NULL</span>);</span><br><span class="line">                timer-&gt;expire = cur + <span class="number">3</span> * TIMESLOT;</span><br><span class="line">                users[connfd].timer = timer;</span><br><span class="line">                timer_lst.add_timer(timer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((sockfd == pipefd[<span class="number">0</span>]) &amp;&amp; (events[i].events &amp; EPOLLIN))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> sig;</span><br><span class="line">                <span class="keyword">char</span> signals[<span class="number">1024</span>];</span><br><span class="line">                ret = recv(pipefd[<span class="number">0</span>], signals, <span class="keyword">sizeof</span>(signals), <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// handle the error</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ret; ++i)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (signals[i])</span><br><span class="line">                        &#123;</span><br><span class="line">                        <span class="keyword">case</span> SIGALRM:</span><br><span class="line">                        &#123;</span><br><span class="line">                            timeout = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">case</span> SIGTERM:</span><br><span class="line">                        &#123;</span><br><span class="line">                            stop_server = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLIN)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">memset</span>(users[sockfd].buf, <span class="string">'\0'</span>, BUFFER_SIZE);</span><br><span class="line">                ret = recv(sockfd, users[sockfd].buf, BUFFER_SIZE - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"get %d bytes of client data %s from %d\n"</span>, ret, users[sockfd].buf, sockfd);</span><br><span class="line">                util_timer* timer = users[sockfd].timer;</span><br><span class="line">                <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (errno != EAGAIN)</span><br><span class="line">                    &#123;</span><br><span class="line">                        cb_func(&amp;users[sockfd]);</span><br><span class="line">                        <span class="keyword">if</span> (timer)</span><br><span class="line">                        &#123;</span><br><span class="line">                            timer_lst.del_timer(timer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    cb_func(&amp;users[sockfd]);</span><br><span class="line">                    <span class="keyword">if</span> (timer)</span><br><span class="line">                    &#123;</span><br><span class="line">                        timer_lst.del_timer(timer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//send( sockfd, users[sockfd].buf, BUFFER_SIZE-1, 0 );</span></span><br><span class="line">                    <span class="keyword">if</span> (timer)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">time_t</span> cur = time(<span class="literal">NULL</span>);</span><br><span class="line">                        timer-&gt;expire = cur + <span class="number">3</span> * TIMESLOT;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"adjust timer once\n"</span>);</span><br><span class="line">                        timer_lst.adjust_timer(timer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// others</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (timeout)</span><br><span class="line">        &#123;</span><br><span class="line">            timer_handler();</span><br><span class="line">            timeout = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(listenfd);</span><br><span class="line">    close(pipefd[<span class="number">1</span>]);</span><br><span class="line">    close(pipefd[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">delete</span>[] users;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
            <div class="readmore">
                <a href="/11.3 关闭非活动连接/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/linux/"><i class="fas fa-hashtag fa-fw"></i>linux</a>
                
                    <a href="/tags/Linux高性能服务器编程/"><i class="fas fa-hashtag fa-fw"></i>Linux高性能服务器编程</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/sln文件VS右键打开方式里多个重复打开选项/">
              
                  sln文件VS右键打开方式里多个重复打开选项
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2022-03-03 星期四
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/软件设置/VS/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              软件设置&nbsp;/&nbsp;VS
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">*1.</span> <span class="string">打开注册表HKEY_CLASSES_ROOT\.sln\OpenWithProgids</span></span><br><span class="line"><span class="string">*2.</span> <span class="string">删除重复的注册表项</span></span><br></pre></td></tr></table></figure>
        
            <div class="readmore">
                <a href="/sln文件VS右键打开方式里多个重复打开选项/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/软件设置/"><i class="fas fa-hashtag fa-fw"></i>软件设置</a>
                
                    <a href="/tags/VS/"><i class="fas fa-hashtag fa-fw"></i>VS</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/MacOS CEF编译/">
              
                  MacOS CEF编译
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2021-11-15 星期一
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/MacOS/CEF/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              MacOS&nbsp;/&nbsp;CEF
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="编译环境："><a href="#编译环境：" class="headerlink" title="编译环境："></a>编译环境：</h2><blockquote>
<ul>
<li>操作系统：MacOS10.15.7</li>
<li>编译器：XCode12.4</li>
</ul>
</blockquote>
<hr>
<h5 id="下面还需要一些准备工作："><a href="#下面还需要一些准备工作：" class="headerlink" title="下面还需要一些准备工作："></a>下面还需要一些准备工作：</h5><p><em>1. 安装python2.7.16，2.7版本应该都可以</em><br>然后在终端中输入：python –version<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.16</span><br></pre></td></tr></table></figure></p>
<p>检测安装的版本号，以及是否安装成功。<br><em>2. 创建文件夹目录</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/Users/calm2012/code/cef/87/automate</span><br><span class="line">/Users/calm2012/code/cef/87/chromium_git</span><br><span class="line">/Users/calm2012/code/cef/87/depot_tools</span><br></pre></td></tr></table></figure></p>
<p><em>3. 下载depot_tools。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/calm2012/code</span><br><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br></pre></td></tr></table></figure></p>
<p><em>4. 添加环境变量。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/Users/calm2012/code/cef/87/depot_tools:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></p>
<p><em>5. 下载automate-git。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/calm2012/code</span><br><span class="line">curl -O https://bitbucket.org/chromiumembedded/cef/raw/master/tools/automate/automate-git.py</span><br></pre></td></tr></table></figure></p>
<p><em>6. 编译配置项设置。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/calm2012/code/cef/87</span><br><span class="line">python automate/automate-git.py --download-dir=/Users/calm2012/code/cef/87/chromium_git --depot-tools-dir=/Users/calm2012/code/cef/87/depot_tools --branch=4280 --force-clean --no-distrib --no-build --x64-buildy</span><br></pre></td></tr></table></figure></p>
<p>automate-git.py 参数介绍<br>–branch 表示你要下载哪个版本的代码，CEF 每个版本都有固定的分支，你去 CEF 项目页查看分支名称指定即可，这里我们编译 2019年9月份目前最新的版本 3809。<br>–no-build 表示只下载代码而不编译，这里只为下载代码，我们还要修改支持多媒体的参数，所以不进行编译<br>–no-distrib 不执行打包项目，这里只为下载代码，我们还要修改支持多媒体的参数，所以不进行打包<br>–force-clean 如果你曾经执行过这个脚本，可能会出错，则加上这个参数，它执行清理残留文件（你也可以手动在 chromium 源码目录执行 git clean -xdf 来清理目录中的多余内容）。<br>automate-git.py 的其他参数可以手动执行 python automate-git.py –help 来查看</p>
<p>如果出现：AttributeError: ‘NoUsableRevError’ object has no attribute ‘message’ 请尝试以下操作。的编译错误。可以按照下边操作<br>打开gclient_scm.py，然后注释下面行</p>
<pre><code>#logging.warning(
#    &quot;Couldn&apos;t find usable revision, will retrying to update instead: %s&quot;,
#    e.message)
</code></pre><p><em>7. 音视频编码格式配置</em><br>修改配置文件/Users/calm2012/code/cef/87/chromium_git/chromium/src/third_party/ffmpeg/chromium/config/Chrome/mac/x64/config.h<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/calm2012/code</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_FLV_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H263_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H263I_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEG4_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEGVIDEO_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MSMPEG4V1_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MSMPEG4V2_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MSMPEG4V3_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV10_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV20_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV30_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV40_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AC3_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AMRNB_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AMRWB_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_COOK_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_SIPR_DECODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_FLV_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H263_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEG4_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MSMPEG4V2_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MSMPEG4V3_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV10_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV20_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AAC_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AC3_ENCODER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AC3_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_COOK_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H263_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEG4VIDEO_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEGVIDEO_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV30_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RV40_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_SIPR_PARSER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AC3_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AMR_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AMRNB_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AMRWB_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AVI_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AVISYNTH_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_FLV_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H263_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H264_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEGTS_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEGTSRAW_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEGVIDEO_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RM_DEMUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AC3_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AMR_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_AVI_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_FLV_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H263_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_H264_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_MPEGTS_MUXER 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONFIG_RM_MUXER 1</span></span><br><span class="line"></span><br><span class="line">然后执行：</span><br><span class="line"><span class="keyword">export</span> GN_DEFINES=<span class="string">"ffmpeg_branding=Chrome proprietary_codecs=true is_official_build=true"</span></span><br></pre></td></tr></table></figure></p>
<p><em>8. 创建Ninja工程文件。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/calm2012/code/cef/87/chromium_git/chromium/src/cef</span><br><span class="line">// 执行脚本，生成工程文件</span><br><span class="line">./cef_create_projects.sh</span><br></pre></td></tr></table></figure></p>
<p><em>9. Ninja Release1编译。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/calm2012/code/cef/87/chromium_git/chromium/src</span><br><span class="line">ninja -C out/Release_GN_x64 cef</span><br></pre></td></tr></table></figure></p>
<p><em>10. 编译 sandbox。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/calm2012/code/cef/87/chromium_git/chromium/src</span><br><span class="line">ninja -C out/Release_GN_x64_sandbox cef_sandbox</span><br></pre></td></tr></table></figure></p>
<p><em>11. 打包头文件、binary等。</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">编译完 Release 版本后开始打包操作:</span><br><span class="line"><span class="built_in">cd</span> /Users/calm2012/code/cef/87/chromium_git/chromium/src/cef/tools</span><br><span class="line"></span><br><span class="line">// --minimal 表示仅发布 Release 版本，不包含 Debug</span><br><span class="line">./make_distrib.sh --ninja-build --x64-build --minimal</span><br><span class="line">在 /Users/calm2012/code/cef/87/chromium_git/chromium/src/cef/binary_distrib 目录下就可以看到打包过的文件了。</span><br></pre></td></tr></table></figure></p>
<p>注意：编译遇到 libtool:   error: unrecognised option: ‘-static’ 错误可以尝试：<br>brew unlink libtool<br>rm -rf /usr/local/bin/libtool<br>which libtool</p>
<hr>
        
            <div class="readmore">
                <a href="/MacOS CEF编译/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/MacOS/"><i class="fas fa-hashtag fa-fw"></i>MacOS</a>
                
                    <a href="/tags/CEF/"><i class="fas fa-hashtag fa-fw"></i>CEF</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/Windows QT5.15.1 编译/">
              
                  Windows QT5.15.1 编译
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2021-11-15 星期一
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/QT/QT/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              QT&nbsp;/&nbsp;QT
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <h2 id="编译环境："><a href="#编译环境：" class="headerlink" title="编译环境："></a>编译环境：</h2><blockquote>
<ul>
<li>操作系统：Windows 10</li>
<li>编译器：Microsoft Visual Studio Enterprise 2017 Version 15.9.41</li>
</ul>
</blockquote>
<h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><ul>
<li>建议Windows 10 在 时间和语言–&gt;语言和区域–&gt;语言 设置为英文，在 时间和语言–&gt;语言和区域–&gt;区域设置为美国避免一些奇怪的错误。</li>
<li>VS建议升级最新版本，之前遇到由于VS版本低导致各种编译错误，升级VS后成功编译。</li>
<li>如果QT源码，需要解压，建议安装最新WinRar 防止解压出错。之前遇到因为WinRar版本问题而发生解压错误。</li>
</ul>
<hr>
<p>#####下面还需要一些准备工作：<br><em>1. 安装python2.7.18，并检查在Windos系统【环境变量】path中对应的路径设置</em><br>然后在widnows cmd中输入：python –version<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Python 2.7.18</span><br></pre></td></tr></table></figure></p>
<p>检测安装的版本号，以及是否安装成功。<br><em>2. 安装安装ruby，并检查在Windos系统【环境变量】path中对应的路径设置</em><br>然后在widnows cmd中输入：ruby –version<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [i386-mingw32]</span><br></pre></td></tr></table></figure></p>
<p><em>3. 安装安装perl，并检查在Windos系统【环境变量】path中对应的路径设置</em><br>然后在widnows cmd中输入：perl –version<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This is perl 5, version 32, subversion 0 (v5.32.0) built <span class="keyword">for</span> MSWin32-x64-multi-thread</span><br></pre></td></tr></table></figure></p>
<p><em>4. 编译oepnssl，编译qt需要用到</em><br>oepnssl源码地址：<a href="https://github.com/openssl/openssl" target="_blank" rel="noopener">https://github.com/openssl/openssl</a><br>编译之前找到configdata.pm和makefile两个文件， 用记事本打开， 搜索 “/MD” 字符串， 替换成 “/MT”,编译选项修改MT<br>编译配置项：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl Configure VC-WIN32 shared no-asm --prefix=<span class="string">"g:\SDK\OpenSSL\openssl-1.1.1"</span> --openssldir=<span class="string">"g:\SDK\OpenSSL\ssl"</span></span><br></pre></td></tr></table></figure></p>
<p>参数说明：<br>–prefix是Openssl编译完后的安装路径。<br>–openssldir是Openssl编译完后的生成的配置文件的安装路径。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a. 打开VS2017中的vcvars32.bat</span><br><span class="line">b. 然后输入 nmake 开始编译。</span><br><span class="line">c. 输入 nmake install 归档头文件等到安装路径</span><br></pre></td></tr></table></figure></p>
<p><em>5. 下载depot_tools，下载地址：<a href="https://chromium.googlesource.com/chromium/tools/depot_tools.git" target="_blank" rel="noopener">https://chromium.googlesource.com/chromium/tools/depot_tools.git</a></em><br>并在Windos系统【环境变量】path中设置对应的路径。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如：D:\SDK\depot_tools</span><br></pre></td></tr></table></figure></p>
<hr>
<p>终于可以开始编译QT了<br>QT5.15.1源码下载：<a href="https://download.qt.io/archive/qt/5.15/5.15.1/single/" target="_blank" rel="noopener">https://download.qt.io/archive/qt/5.15/5.15.1/single/</a><br>Windows编译配置项：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure -opensource -platform win32-msvc2017 -developer-build -mp -debug-and-release -force-debug-info -v -confirm-license OPENSSL_PREFIX=D:\SDK\oepnssl\1.1.1g\debug_md -openssl-linked -I  D:\SDK\oepnssl\1.1.1g\debug_md\include -L D:\SDK\oepnssl\1.1.1g\debug_md\lib OPENSSL_LIBS=<span class="string">"libssl.lib libcrypto.lib Ws2_32.lib  Gdi32.lib Advapi32.lib Crypt32.lib User32.lib"</span> -webengine-proprietary-codecs -prefix D:\SDK\build\qt5.15.1</span><br></pre></td></tr></table></figure></p>
<p>MacOS编译配置项:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure -opensource -platform macx-clang -developer-build -debug-and-release -force-debug-info -v -confirm-license -skip qtwebengine -prefix ~/SDK/QT/5.15.1/macos</span><br></pre></td></tr></table></figure></p>
<p>IOS编译配置项:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure -opensource -xplatform macx-ios-clang -developer-build -debug-and-release -force-debug-info -confirm-license -nomake examples -nomake tests -skip qtwebengine -prefix ~/SDK/QT/5.15.1/ios</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a. 打开VS2017中的 x64_x86 Cross Tools Command Prompt <span class="keyword">for</span> VS 2017</span><br><span class="line">b. 输入nmake</span><br><span class="line">c. 输入nmake install</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mac和ios都下面命令：</span><br><span class="line">a. 打开终端，进入到源码目录</span><br><span class="line">b. 输入make 或者 make -j20（j20表示用20个线程构建，加快构建速度，最大线程数可以参考cpu的线程数）</span><br><span class="line">c. 输入make install</span><br></pre></td></tr></table></figure>
<p>注意：如果需要重新编译可以删除<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">config.cache</span></span><br><span class="line"><span class="string">.qmake.cache</span></span><br><span class="line"><span class="string">config.tests</span></span><br></pre></td></tr></table></figure></p>
<p>重新开始编译。</p>
<hr>
<p>#####参考文章<br>Qt for Windows - Building from Source：<br><a href="https://doc.qt.io/qt-5/windows-building.html" target="_blank" rel="noopener">https://doc.qt.io/qt-5/windows-building.html</a><br>Qt for Windows - Requirements：<br><a href="https://doc.qt.io/qt-5/windows-requirements.html" target="_blank" rel="noopener">https://doc.qt.io/qt-5/windows-requirements.html</a><br>Qt for Windows：<br><a href="https://doc.qt.io/qt-5/windows.html" target="_blank" rel="noopener">https://doc.qt.io/qt-5/windows.html</a><br>
        
            <div class="readmore">
                <a href="/Windows QT5.15.1 编译/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/QT/"><i class="fas fa-hashtag fa-fw"></i>QT</a>
                
            </div>
        
    </p></section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/C++指针详解/">
              
                  C++指针详解
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2021-08-25 星期三
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/C-深入浅出系列/C-指针详解/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              C++深入浅出系列&nbsp;/&nbsp;C++指针详解
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">111</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">222</span>;</span><br><span class="line"><span class="keyword">int</span> c = <span class="number">333</span>;</span><br><span class="line"><span class="keyword">int</span>* pp1[<span class="number">3</span>]&#123;&amp;a, &amp;b, &amp;c&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">decltype</span>(pp1)* Fun1(<span class="keyword">int</span> nNum);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">int_array_t</span>[<span class="number">3</span>];</span><br><span class="line">typedef int (*int_array_ptr_t)[3];</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*int_array_ptr_t2[<span class="number">3</span>])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int_array_t</span> obj = &#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;;</span><br><span class="line"><span class="keyword">int_array_ptr_t</span> p_obj;</span><br><span class="line">int_array_ptr_t2* p_obj2 = &amp;pp1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int_array_t</span>* fun0(<span class="keyword">int</span> n);</span><br><span class="line"><span class="keyword">int_array_ptr_t</span> fun1(<span class="keyword">int</span> n);</span><br><span class="line"><span class="function">int_array_ptr_t2* <span class="title">fun3</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 普通指针</span></span><br><span class="line">    <span class="keyword">int</span> nNum = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">int</span>* p0 = &amp;nNum;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *p0 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> p1[<span class="number">3</span>]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 由n个int型指针组成的数组;数组的元素是指针类型</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> *p2[<span class="number">3</span>]&#123;&amp;a, &amp;b, &amp;c&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::defaultfloat;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::hex &lt;&lt; <span class="built_in">std</span>::showbase;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"&amp;a:\t"</span> &lt;&lt; (<span class="keyword">size_t</span>)&amp;a &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"p3[0]:\t"</span> &lt;&lt; (<span class="keyword">size_t</span>)p2[<span class="number">0</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"&amp;b:\t"</span> &lt;&lt; (<span class="keyword">size_t</span>)&amp;b &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"p3[1]:\t"</span> &lt;&lt; (<span class="keyword">size_t</span>)p2[<span class="number">1</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"&amp;c:\t"</span> &lt;&lt; (<span class="keyword">size_t</span>)&amp;c &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"p3[2]:\t"</span> &lt;&lt; (<span class="keyword">size_t</span>)p2[<span class="number">2</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 一个指向由n个元素的数组的指针，数组元素的值为int型</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::dec;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>(*p3)[<span class="number">3</span>] = &amp;p1;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (*p3)[<span class="number">0</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (*p3)[<span class="number">1</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (*p3)[<span class="number">2</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 指向int型指针的指针</span></span><br><span class="line">    <span class="keyword">int</span>** p4 = &amp;p0;</span><br><span class="line">    **p4 = <span class="number">123456</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; **p4 &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 函数指针</span></span><br><span class="line">    <span class="keyword">int</span> (*p5)(<span class="keyword">int</span>) = show;                  <span class="comment">// 一个指向有一个整型参数, 返回值为整型的函数的指针</span></span><br><span class="line">    p5(<span class="number">1</span>);</span><br><span class="line">    (*p5)(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 带一个int型参数返回值为指向n个int型指针元素的数组的函数</span></span><br><span class="line">    <span class="keyword">int</span>*(*p6(<span class="keyword">int</span>))[<span class="number">3</span>];                      <span class="comment">// p是一个函数, 函数的参数为int型;函数的返回值为指针;指针指向是一个数组;数组的元素为指针;数组的元素指针为int型指针</span></span><br><span class="line">    <span class="keyword">decltype</span>(pp1)* pPP1 = Fun1(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *((<span class="keyword">int</span>*)((*pPP1)[<span class="number">0</span>])) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *((<span class="keyword">int</span>*)((*pPP1)[<span class="number">1</span>])) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *((<span class="keyword">int</span>*)((*pPP1)[<span class="number">2</span>])) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    int_array_ptr_t2* pAray3 = fun3(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *((<span class="keyword">int</span>*)((*pAray3)[<span class="number">0</span>])) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *((<span class="keyword">int</span>*)((*pAray3)[<span class="number">1</span>])) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; *((<span class="keyword">int</span>*)((*pAray3)[<span class="number">2</span>])) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// int (*func)(int *p, int (*f)(int*));</span></span><br><span class="line">    <span class="comment">// 7. func是一个指向函数的指针，这类函数具有int *和int (*)(int*)这样的形参，返回值为int类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// int (*func[3])(int);</span></span><br><span class="line">    <span class="comment">// 8. func数组的元素是函数类型的指针，它所指向的函数具有int类型的形参，返回值类型为int</span></span><br><span class="line">    <span class="keyword">int</span> (*func[<span class="number">3</span>])(<span class="keyword">int</span>) = &#123;show, show, show&#125;;</span><br><span class="line"></span><br><span class="line">    func[<span class="number">0</span>](<span class="number">0</span>);</span><br><span class="line">    func[<span class="number">1</span>](<span class="number">0</span>);</span><br><span class="line">    func[<span class="number">2</span>](<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// int (*(*func)[3])(int);</span></span><br><span class="line">    <span class="comment">// 9. func是一个指向数组的指针，这个数组的元素是函数指针，这些指针指向具有int形参，返回值为int类型的函数。</span></span><br><span class="line">    <span class="keyword">int</span> (*(*func9)[<span class="number">3</span>])(<span class="keyword">int</span>) = &amp;func;</span><br><span class="line">    (*func9)[<span class="number">0</span>](<span class="number">0</span>);</span><br><span class="line">    (*func9)[<span class="number">1</span>](<span class="number">0</span>);</span><br><span class="line">    (*func9)[<span class="number">2</span>](<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// int (*(*func)(int))[3];</span></span><br><span class="line">    <span class="comment">// 10. func是一个函数指针，这类函数具有int类型的形参，返回值是指向数组的指针，所指向的数组的元素是具有3个int元素的数组</span></span><br><span class="line">    <span class="keyword">int</span>(*(*func10)(<span class="keyword">int</span>))[<span class="number">3</span>] = fun1;</span><br><span class="line">    <span class="keyword">int_array_ptr_t</span> p10 = func10(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (*p10)[<span class="number">0</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (*p10)[<span class="number">1</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (*p10)[<span class="number">2</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"show function."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">decltype</span>(pp1)* Fun1(<span class="keyword">int</span> nNum) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;pp1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int_array_t</span>* fun0(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    p_obj = &amp;obj;</span><br><span class="line">    <span class="keyword">return</span> &amp;obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int_array_ptr_t</span> fun1(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    p_obj = fun0(n);</span><br><span class="line">    <span class="keyword">return</span> p_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">int_array_ptr_t2* <span class="title">fun3</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> p_obj2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
            <div class="readmore">
                <a href="/C++指针详解/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/C-深入浅出系列/"><i class="fas fa-hashtag fa-fw"></i>C++深入浅出系列</a>
                
                    <a href="/tags/C-指针详解/"><i class="fas fa-hashtag fa-fw"></i>C++指针详解</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/跨平台开发简介/">
              
                  跨平台简介
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2021-08-02 星期一
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/跨平台/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              跨平台
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <hr>
<p>随着后PC时代的到来，以及互联网的高速发展，当前环境下拥有多平台设备的用户越来越多，开发者不得不考虑跨平台开发，以期多平台有一致的使用体验、获得更多的用户。现在主流的平台有：Android、IOS、Windows、MacOS、Linux。面对如此多的平台我们改如何面对，是一个值得思考的问题。下面我介绍今天需要讨论的一些主题：</p>
<blockquote>
<ul>
<li>什么是跨平台？</li>
<li>跨平台开发的意义？</li>
<li>跨平台开发需要注意些什么？</li>
<li>跨平台开发的现状？</li>
</ul>
</blockquote>
<h2 id="什么是跨平台？"><a href="#什么是跨平台？" class="headerlink" title="什么是跨平台？"></a>什么是跨平台？</h2><p>程序源码不依赖操作系统、不依赖硬件环境（如各种CPU指令集），可以在不同的操作系统上运行。</p>
<p>为了弄明白跨平台底层原理，我们需要从程序的生成看起，而程序又是由编程语言开发的，所以我们先从的开发语言看起：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A[机器语言] --&gt; B[汇编语言]</span><br><span class="line">    B --&gt; C[C/C++]</span><br><span class="line">    B --&gt; D[Java]</span><br><span class="line">    B --&gt; E[Python]</span><br><span class="line">    B --&gt; F[Go]</span><br><span class="line">    B --&gt; G[其它...]</span><br></pre></td></tr></table></figure>
<p><strong>机器语言</strong>: 由0 1代码组成，可以直接被计算机硬件所识别，与底层硬件高度耦合，显然无法跨平台。<br><strong>汇编语言</strong>: 采用字母、单词来表示一条指令，与硬件高度耦合，无法跨平台。<br><strong>高级语言</strong>: C/C++、Java、Python、Go、… 面向过程或者面向对象，开发简单、高效，做到了与硬件无关，是我们跨平台开发的选择。</p>
<hr>
<h4 id="从实现方式上跨平台可以分为两大阵营："><a href="#从实现方式上跨平台可以分为两大阵营：" class="headerlink" title="从实现方式上跨平台可以分为两大阵营："></a>从实现方式上跨平台可以分为两大阵营：</h4><p>#####编译型:<br>    C、C++、Delphi、Pascal 使用不同平台对应的编译器，只需编译一次，生成可以执行文件。由不同平台不同的【编译器】做支撑<br>    优点：程序执行效率高、使用内存低<br>    不点：编译出来的可执行文件与平台相关，不能在其它平台直接运行。</p>
<p>#####解释型:<br>    解释型的语言包括：Javascript、Python、Ruby、Perl、…等 。由不同平台不同的【解释器虚拟机】做支撑<br>    优点：不需要编译，既可以跨平台。<br>    不足：每次运行都需要将源代码解释称机器码并执行，效率较低，内存使用率高。</p>
<pre><code>注意：编译型 + 解释型的混合体 : Java  Java代码要编译，解释运行在JVM上。
</code></pre><hr>
<h2 id="跨平台开发的意义？"><a href="#跨平台开发的意义？" class="headerlink" title="跨平台开发的意义？"></a>跨平台开发的意义？</h2><p><em>1. 用户在不同平台有近似的用户体验、提高用户体验。</em><br><em>2. 公司可以获取更多用户。</em><br><em>3. 一份代码多平台部署，提高开发效率、可维护性。</em><br><em>4. 节省时间成本和人员成本。</em><br><em>5. …</em></p>
<hr>
<h2 id="跨平台开发需要注意什么？"><a href="#跨平台开发需要注意什么？" class="headerlink" title="跨平台开发需要注意什么？"></a>跨平台开发需要注意什么？</h2><p>编程语言、操作系统、代码编码格式、x64、x86、同一操作系统不同操作系统版本、操作系统版本都相同不同机型<br><em>1. 选择合适的编程语言。看编程语言本身对跨平台支持的程度，如windows的批出就不行。</em><br><em>2. 操作系统。目标操作系统都有哪些。</em><br><em>3. 代码文件的编码格式。不恰当的格式，可能再其它平台编译失败。</em><br><em>4. 程序是32位，还是64位，还是说在有的平台32位有的平台64位。</em><br><em>5. 需要考虑同一操作系统不同操作系统版本。</em><br><em>6. 需要考虑操作系统版本相同但是机型不同，适配。</em></p>
<hr>
<h2 id="跨平台开发的现状？"><a href="#跨平台开发的现状？" class="headerlink" title="跨平台开发的现状？"></a>跨平台开发的现状？</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A[跨平台开发]</span><br><span class="line">    A --&gt; B[Web Java Script派]</span><br><span class="line">    A --&gt; C[代码转换派]</span><br><span class="line">    A --&gt; D[编译派]</span><br><span class="line">    A --&gt; E[中间派]</span><br><span class="line">    A --&gt; F[解释器虚拟机派]</span><br></pre></td></tr></table></figure>
<h4 id="1-Web-Java-Script派"><a href="#1-Web-Java-Script派" class="headerlink" title="1. Web Java Script派"></a>1. Web Java Script派</h4><ul>
<li><p><strong>React Native</strong>：<br>React Native基于JavaScript和React(用于构建用户界面的JavaScript库)。<br>Facebook于2015年4月开源的跨平台移动应用开发框架。<br>主要擅长于IOS、Android，也能应用于Windows、MacOS、linux<br>官网：<a href="https://reactnative.dev/" target="_blank" rel="noopener">https://reactnative.dev/</a><br>MacOS: <a href="https://github.com/ptmt/react-native-macos" target="_blank" rel="noopener">https://github.com/ptmt/react-native-macos</a><br>Windows: <a href="https://gitee.com/mirrors/react-native-windows/" target="_blank" rel="noopener">https://gitee.com/mirrors/react-native-windows/</a><br>linux: <a href="https://gitlab.com/react-native-linux/react-native-linux" target="_blank" rel="noopener">https://gitlab.com/react-native-linux/react-native-linux</a><br>使用React Native成功案例：<a href="https://reactnative.dev/showcase" target="_blank" rel="noopener">https://reactnative.dev/showcase</a><br>Facebook Android • iOS<br>Instagram Android • iOS<br>Skype Android • iOS<br>Tencent QQ Android<br>JD（手机京东）Android • iOS</p>
</li>
<li><p><strong>Electron</strong>:<br>2011 年左右，中国英特尔开源技术中心的王文睿（Roger Wang）希望能用 Node.js 来操作 WebKit，而创建了 node-webkit 项目，这就是 NW.js 的前身。<br>2012 年，故事的另一个主角赵成（Cheng Zhao）加入到王文睿的小组，并对 node-webkit 项目做出了大量的改进，<br>后来赵成离开了中国英特尔开源技术中心，帮助 github 团队尝试把 node-webkit 应用到 Atom 编辑器上，再后来 github 把这个项目开源出来，最终更名为Electron。<br>官网：<a href="https://www.electronjs.org/" target="_blank" rel="noopener">https://www.electronjs.org/</a><br>Electron基于Nodejs和Chromium的跨平台桌面软件开发框架。使用 JavaScript，HTML 和 CSS 构建跨平台的桌面应用程序。<br>Electron擅长于Mac、Windows、Linux也能支持Android、IOS<br>Mac App Store 应用程序提交指南: <a href="https://www.electronjs.org/docs/tutorial/mac-app-store-submission-guide" target="_blank" rel="noopener">https://www.electronjs.org/docs/tutorial/mac-app-store-submission-guide</a><br>高版本使用CARemoteLayer 未公开api ios不能上架，AppStore有低版本Electron支持ios。<br>使用Electron的成功案例: <a href="https://www.electronjs.org/apps" target="_blank" rel="noopener">https://www.electronjs.org/apps</a><br>Visual Studio Code<br>GitBlade<br>GitHub Desktop<br>飞书<br>迅雷X</p>
</li>
<li><p><strong>PhoneGap</strong>:<br>采用HTML，CSS和JavaScript的技术，创建移动跨平台移动应用程序的快速开发平台  Android • iOS<br>2011年7月29日，PhoneGap发布了1.0版产品，现在由Adobe拥有.<br>PhoneGap程序的加载和UI接口的反应都比本地的程序慢。Adobe警告开发者，由于使用PhoneGap框架开发的程序运行速度可能会太慢或使用体验不够“原生”.</p>
</li>
</ul>
<h4 id="2-代码转换派"><a href="#2-代码转换派" class="headerlink" title="2. 代码转换派"></a>2. 代码转换派</h4><ul>
<li><p><strong>Java 转成 Objective-C</strong>：<br><strong>j2objc</strong>（Java to iOS Objective-C translation tool and runtime）: 谷歌2019推出，不涉及UI的java代码转换(翻译)为objective-c的代码<br><a href="https://github.com/google/j2objc" target="_blank" rel="noopener">https://github.com/google/j2objc</a></p>
</li>
<li><p><strong>Objective-C 转成 Java</strong>：<br><strong>MyAppConverter</strong>: 收费，支持UI部分的转换。<br><a href="https://www.myappconverter.com/v2/" target="_blank" rel="noopener">https://www.myappconverter.com/v2/</a><br><a href="https://github.com/myappconverter" target="_blank" rel="noopener">https://github.com/myappconverter</a><br><strong>Apportable</strong>:<br>2011年成立，主要主要应用于移动游戏。<br><a href="https://github.com/apportable" target="_blank" rel="noopener">https://github.com/apportable</a><br><strong>Java 转成 C#</strong><br>略.<br><strong>XMLVM</strong>:<br>将java字节码文件或.NET可执行文件翻译成XML文档，然后基于这份生成的文档可以进行各种转换。如将Java或.NET应用程序编译成Javascript程序，或将Java程序编译成Object-C程序<br><a href="http://xmlvm.org/overview/" target="_blank" rel="noopener">http://xmlvm.org/overview/</a><br><a href="https://github.com/tisoft/xmlvm" target="_blank" rel="noopener">https://github.com/tisoft/xmlvm</a></p>
</li>
</ul>
<h4 id="3-编译派"><a href="#3-编译派" class="headerlink" title="3. 编译派"></a>3. 编译派</h4><p><strong>C</strong><br><strong>C++</strong><br><strong>QT</strong><br><strong>…</strong></p>
<h4 id="4-中间派（基于js-与-编译流之间）："><a href="#4-中间派（基于js-与-编译流之间）：" class="headerlink" title="4. 中间派（基于js 与 编译流之间）："></a>4. 中间派（基于js 与 编译流之间）：</h4><ul>
<li><strong>Flutter</strong>：<br>Google开源，上线时间2015年5月。<br>Flutter采用Dart语言<br>Dart是面向对象的、类定义的、单继承的语言。需要编译、Dart2强类型语言。<br><a href="https://www.dartcn.com/" target="_blank" rel="noopener">https://www.dartcn.com/</a><br>优势：程序运行效率相对较高、Google开源的技术支持<br>不足：开源库相对比较欠缺，更新频次不足</li>
</ul>
<h4 id="5-解释器虚拟机："><a href="#5-解释器虚拟机：" class="headerlink" title="5. 解释器虚拟机："></a>5. 解释器虚拟机：</h4><p><strong>Java</strong><br><strong>Python</strong><br><strong>Perl</strong><br><strong>Lua</strong><br><strong>…</strong></p>
<p>其它资料：<br>2021最新15个跨平台App开发框架：<a href="https://www.jianshu.com/p/3bf119de6c5f" target="_blank" rel="noopener">https://www.jianshu.com/p/3bf119de6c5f</a></p>
<hr>
        
            <div class="readmore">
                <a href="/跨平台开发简介/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/跨平台/"><i class="fas fa-hashtag fa-fw"></i>跨平台</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
          
            <div class="post-wrapper">
              <article class="post reveal ">
    
<section class="meta">
  
  
  <div class="meta" id="header-meta">
    
      <h2 class="title">
          <a href="/C++深入浅出之：C++虚表(一)/">
              
                  C++深入浅出之：C++虚表(一)
              
          </a>
      </h2>
    

    <div class="new-meta-box">
      
        <div class="new-meta-item author">
          <a href="https://calm2012.github.io/calm2012.github.io">
            <i class="fas fa-user" aria-hidden="true"></i>
            calm2012
          </a>
        </div>
      
      
        <div class="new-meta-item date">
          <a class="notlink">
            <i class="fas fa-clock" aria-hidden="true"></i>
            2021-02-07 星期日
          </a>
        </div>
      
      
        
          
          <div class="new-meta-item category">
            <a href="/categories/C-深入浅出系列/C-深入浅出之：C-虚表-一/">
              <i class="fas fa-folder-open" aria-hidden="true"></i>
              C++深入浅出系列&nbsp;/&nbsp;C++深入浅出之：C++虚表(一)
            </a>
          </div>
        
      
      
      
    </div>
    <hr>
  </div>
</section>

    <section class="article typo">
        <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">实验环境:</span> <span class="string">windows10</span> <span class="string">x64</span>  <span class="string">VS2019</span></span><br><span class="line"><span class="string">我们来分析最基本的</span> <span class="string">单继承</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Base show.\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">virtual</span> ~Base() &#123;&#125;</span><br><span class="line">  <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTest</span> :</span> <span class="keyword">public</span> Base &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"CTest show.\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Base b;</span><br><span class="line">  b.show();</span><br><span class="line"></span><br><span class="line">  Base* pTest = <span class="keyword">new</span> CTest();</span><br><span class="line"></span><br><span class="line">  pTest-&gt;show();</span><br><span class="line">  <span class="keyword">delete</span> pTest;</span><br><span class="line">  pTest = <span class="literal">nullptr</span>; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s3.ax1x.com/2021/02/07/yN4SM9.png"><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="string">可以看到pTest的地址是0x0021ab4c，也是导入表的地址</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://s3.ax1x.com/2021/02/07/yN4FIK.png"><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span><span class="string">导入第一个地址：0x00211573，即</span> <span class="attr">CTest::show的地址</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://s3.ax1x.com/2021/02/07/yN4APO.png"><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.</span><span class="string">切换到汇编验证一下</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://s3.ax1x.com/2021/02/07/yN4VRe.png"><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4.</span><span class="string">这里eax就是CTest::show的地址，和</span> <span class="string">上边通过导入表看到地址是一样的，都是0x00211573，也就演示了虚表中，</span></span><br><span class="line"><span class="string">成员的存放方式</span></span><br></pre></td></tr></table></figure></p>
        
            <div class="readmore">
                <a href="/C++深入浅出之：C++虚表(一)/" class="flat-box">
                    <i class="fas fa-book-open fa-fw" aria-hidden="true"></i>
                    阅读全文
                </a>
            </div>
        

        
            <div class="full-width auto-padding tags">
                
                    <a href="/tags/C-深入浅出系列/"><i class="fas fa-hashtag fa-fw"></i>C++深入浅出系列</a>
                
                    <a href="/tags/C-深入浅出之：C-虚表-一/"><i class="fas fa-hashtag fa-fw"></i>C++深入浅出之：C++虚表(一)</a>
                
            </div>
        
    </section>
</article>

            </div>
          
        
      

  </section>






  
      <br>
      <div class="prev-next">
          <div class="prev-next">
              
              <p class="current">
                  1 / 7
              </p>
              
                  <a class="next" rel="next" href="/page/2/">
                      <section class="post next">
                          &nbsp;下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i>
                      </section>
                  </a>
              

          </div>
      </div>

  

  <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
  

  




        </div>
        <aside class='l_side'>
            
  
  
    
      
      
        <section class="author">
  <div class="content pure">
    
      <div class="avatar">
        <img class="avatar" src="https://s4.ax1x.com/2022/03/03/bJYa79.jpg">
      </div>
    
    
      <div class="text">
        
        
        
          <p><span id="jinrishici-sentence">柳暗花明又一村</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
  </div>
</section>

      
    
  
    
      
      
        <section class="plain">
  
<header class="pure">
  <div><i class="fas fa-bullhorn fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;注意啦～</div>
  
    <a class="rightBtn" target="_blank" rel="external nofollow noopener noreferrer" href="https://xaoxuu.com/wiki/material-x/" title="https://xaoxuu.com/wiki/material-x/">
    <i class="fas fa-question-circle fa-fw"></i></a>
  
</header>

  <div class="content pure">
    <p>欢迎访问程序员小站,喜欢的朋友可以安利给身边的朋友哦～ <br> QQ群:&emsp;&emsp;&emsp;&nbsp;&nbsp;<a href="http://shang.qq.com/wpa/qunwpa?idkey=38fbc1431dcb54c10cf7ef249808bad95b939883031ec289660b8d6c4bd4cb27">103197177</a> <br>今日头条ID:&emsp;<a href="https://www.toutiao.com/c/user/5924607123/">光影星辰彩虹之南</a></p>

  </div>
</section>

      
    
  
    
      
      
        
  <section class="category">
    
<header class="pure">
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;所有分类</div>
  
</header>

    <div class="content pure">
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/C-深入浅出系列/" href="/categories/C-深入浅出系列/"><div class="name">C++深入浅出系列</div><div class="badge">(3)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/C-深入浅出系列/C-指针详解/" href="/categories/C-深入浅出系列/C-指针详解/"><div class="name">C++指针详解</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/C-深入浅出系列/C-深入浅出之：C-函数的一些底层细节/" href="/categories/C-深入浅出系列/C-深入浅出之：C-函数的一些底层细节/"><div class="name">C++深入浅出之：C++函数的一些底层细节</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/C-深入浅出系列/C-深入浅出之：C-虚表-一/" href="/categories/C-深入浅出系列/C-深入浅出之：C-虚表-一/"><div class="name">C++深入浅出之：C++虚表(一)</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/MacOS/" href="/categories/MacOS/"><div class="name">MacOS</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/MacOS/CEF/" href="/categories/MacOS/CEF/"><div class="name">CEF</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/QT/" href="/categories/QT/"><div class="name">QT</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/QT/QT/" href="/categories/QT/QT/"><div class="name">QT</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Resharper/" href="/categories/Resharper/"><div class="name">Resharper</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/Resharper/Resharper/" href="/categories/Resharper/Resharper/"><div class="name">Resharper</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Ruby/" href="/categories/Ruby/"><div class="name">Ruby</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/Ruby/Ruby/" href="/categories/Ruby/Ruby/"><div class="name">Ruby</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/Windows/" href="/categories/Windows/"><div class="name">Windows</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/Windows/UAC实现原理/" href="/categories/Windows/UAC实现原理/"><div class="name">UAC实现原理</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/cmake/" href="/categories/cmake/"><div class="name">cmake</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/cmake/cmake/" href="/categories/cmake/cmake/"><div class="name">cmake</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/linux/" href="/categories/linux/"><div class="name">linux</div><div class="badge">(49)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/linux/Linux编译环境设置/" href="/categories/linux/Linux编译环境设置/"><div class="name">Linux编译环境设置</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/linux/Linux软件安装/" href="/categories/linux/Linux软件安装/"><div class="name">Linux软件安装</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/linux/Linux高性能服务器编程/" href="/categories/linux/Linux高性能服务器编程/"><div class="name">Linux高性能服务器编程</div><div class="badge">(42)</div></a></li>
        
          <li><a class="flat-box" title="/categories/系统设置/" href="/categories/系统设置/"><div class="name">系统设置</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/系统设置/Win10/" href="/categories/系统设置/Win10/"><div class="name">Win10</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/编译错误/" href="/categories/编译错误/"><div class="name">编译错误</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/编译错误/VC/" href="/categories/编译错误/VC/"><div class="name">VC</div><div class="badge">(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/自动化测试/" href="/categories/自动化测试/"><div class="name">自动化测试</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/自动化测试/GoogleTest/" href="/categories/自动化测试/GoogleTest/"><div class="name">GoogleTest</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/跨平台/" href="/categories/跨平台/"><div class="name">跨平台</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box" title="/categories/软件设置/" href="/categories/软件设置/"><div class="name">软件设置</div><div class="badge">(4)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/软件设置/Everything/" href="/categories/软件设置/Everything/"><div class="name">Everything</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/软件设置/VM/" href="/categories/软件设置/VM/"><div class="name">VM</div><div class="badge">(1)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/软件设置/VS/" href="/categories/软件设置/VS/"><div class="name">VS</div><div class="badge">(1)</div></a></li>
        
      </ul>
    </div>
  </section>


      
    
  
    
      
      
        
  <section class="tagcloud">
    
<header class="pure">
  <div><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;热门标签</div>
  
</header>

    <div class="content pure">
      <a href="/tags/C-指针详解/" style="font-size: 14px; color: #999">C++指针详解</a> <a href="/tags/C-深入浅出之：C-函数的一些底层细节/" style="font-size: 14px; color: #999">C++深入浅出之：C++函数的一些底层细节</a> <a href="/tags/C-深入浅出之：C-虚表-一/" style="font-size: 14px; color: #999">C++深入浅出之：C++虚表(一)</a> <a href="/tags/C-深入浅出系列/" style="font-size: 18px; color: #7e7e7e">C++深入浅出系列</a> <a href="/tags/CEF/" style="font-size: 14px; color: #999">CEF</a> <a href="/tags/Everything/" style="font-size: 14px; color: #999">Everything</a> <a href="/tags/GoogleTest/" style="font-size: 14px; color: #999">GoogleTest</a> <a href="/tags/Linux编译环境设置/" style="font-size: 14px; color: #999">Linux编译环境设置</a> <a href="/tags/Linux软件安装/" style="font-size: 14px; color: #999">Linux软件安装</a> <a href="/tags/Linux高性能服务器编程/" style="font-size: 22px; color: #636363">Linux高性能服务器编程</a> <a href="/tags/MacOS/" style="font-size: 14px; color: #999">MacOS</a> <a href="/tags/QT/" style="font-size: 16px; color: #8b8b8b">QT</a> <a href="/tags/Resharper/" style="font-size: 14px; color: #999">Resharper</a> <a href="/tags/Ruby/" style="font-size: 14px; color: #999">Ruby</a> <a href="/tags/UAC实现原理/" style="font-size: 14px; color: #999">UAC实现原理</a> <a href="/tags/VC/" style="font-size: 16px; color: #8b8b8b">VC</a> <a href="/tags/VM/" style="font-size: 14px; color: #999">VM</a> <a href="/tags/VS/" style="font-size: 14px; color: #999">VS</a> <a href="/tags/Win10/" style="font-size: 14px; color: #999">Win10</a> <a href="/tags/Windows/" style="font-size: 14px; color: #999">Windows</a> <a href="/tags/cmake/" style="font-size: 14px; color: #999">cmake</a> <a href="/tags/linux/" style="font-size: 24px; color: #555">linux</a> <a href="/tags/系统设置/" style="font-size: 14px; color: #999">系统设置</a> <a href="/tags/编译错误/" style="font-size: 16px; color: #8b8b8b">编译错误</a> <a href="/tags/自动化测试/" style="font-size: 14px; color: #999">自动化测试</a> <a href="/tags/跨平台/" style="font-size: 14px; color: #999">跨平台</a> <a href="/tags/软件设置/" style="font-size: 20px; color: #707070">软件设置</a>
    </div>
  </section>


      
    
  
    
      
      
        

      
    
  
    
      
      
        



      
    
  
    
      
      
        

      
    
  


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
    </div>
    <footer id="footer" class="clearfix">
  
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>本站使用 <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> 作为主题，总访问量为 <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次。
  </div>
</footer>

    <script>setLoadingBarProgress(80);</script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>


  
    <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
    <script type="text/javascript">
      $(function() {
        const $reveal = $('.reveal');
    		if ($reveal.length === 0) return;
    		const sr = ScrollReveal({ distance: 0 });
    		sr.reveal('.reveal');
      });
    </script>
  
  
    <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
    <script type="text/javascript">
      $(function() {
        Waves.attach('.flat-btn', ['waves-button']);
        Waves.attach('.float-btn', ['waves-button', 'waves-float']);
        Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
        Waves.attach('.flat-box', ['waves-block']);
        Waves.attach('.float-box', ['waves-block', 'waves-float']);
        Waves.attach('.waves-image');
        Waves.init();
      });
    </script>
  
  
    <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>
  
  
  

  
  
  
  
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    
      
        <script src="https://cdn.jsdelivr.net/gh/xaoxuu/volantis@1/js/volantis.min.js"></script>
      
    
    <script>
    var GUEST_INFO = ['nick','mail','link'];
    var guest_info = 'nick,mail,link'.split(',').filter(function(item){
      return GUEST_INFO.indexOf(item) > -1
    });
    var notify = 'false' == true;
    var verify = 'false' == true;
    var valine = new Valine();
    valine.init({
      el: '#valine_container',
      notify: notify,
      verify: verify,
      guest_info: guest_info,
      
      appId: "AHP3eJnwKM7kHv6e0Rwre6qD-gzGzoHsz",
      appKey: "A2poayI0o1E4qSbUgKidPw2Q",
      placeholder: "快来评论吧~",
      pageSize:'10',
      avatar:'mp',
      lang:'zh-cn',
      highlight:''
    })
    </script>
  

  
    <script src="/js/app.js"></script>
<script src="/js/search.js"></script>
  






    <script>setLoadingBarProgress(100);</script>
</body>
</html>
